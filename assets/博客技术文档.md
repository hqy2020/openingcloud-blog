# openingClouds 博客技术文档（基于素材与需求）

## 0. 文档信息

- 文档版本：v1.0
- 编写日期：2026-02-13
- 设计输入：
  - `assets/博客需求文档.md`
  - `assets/` 素材文件（Logo、封面、Hero、OG、404 等）
  - 当前代码基线（`src/`、`public/`、`migrations/`）
- 技术栈：Astro 5 + React 19 + Tailwind 4 + Motion + Cloudflare Workers + D1

---

## 1. 建设目标

- 以“云海穿越”视觉体系完成前台首页、分类页、文章页、全局组件的一致化实现。
- 以 D1 为单一数据源，落地首页模块化数据管理（时间线、旅行足迹、社交图谱、高光时刻）。
- 保持管理员与访客的数据可见性分层，满足隐私需求。
- 建立素材接入规范，确保生产环境资源可控（体积、格式、缓存、回退）。

### 1.1 范围

- 前台：`/`、`/tech/`、`/learning/`、`/life/`、`/posts/[slug]/`
- 后台：`/admin/*` 六大模块
- API：`/api/*` 与 `/api/admin/*`
- 数据：D1 迁移、CRUD、聚合查询
- 素材：Logo、封面图、Hero 图/视频、OG 图、404 图、图标、地图 SVG

### 1.2 非范围

- 新增第三方 CMS
- 多租户能力
- 全量国际化

---

## 2. 现状基线（2026-02-13）

### 2.1 已实现能力

- 首页七段式结构与动画框架已完成：`src/react/sections/HomePageExperience.tsx`
- 分类页双列瀑布流、标签筛选、排序、加载更多已完成：`src/react/sections/CategoryMasonry.tsx`
- 文章详情页阅读进度、目录、封面视差已完成：`src/layouts/PostLayout.astro`
- 后台模块与 CRUD API 基础已完成：
  - 旅行：`src/pages/admin/travel/index.astro` + `src/pages/api/admin/travel/*`
  - 社交：`src/pages/admin/social/index.astro` + `src/pages/api/admin/social/*`
  - 时间线：`src/pages/admin/timeline/index.astro` + `src/pages/api/admin/timeline/*`
  - 高光：`src/pages/admin/highlights/index.astro` + `src/pages/api/admin/highlights/*`
- D1 表结构已覆盖核心模块：`posts`、`timeline_nodes`、`travel_places`、`social_friends`、`highlight_stages`、`highlight_items`

### 2.2 关键缺口

- 首页 Section2/3/4/5 目前为前端静态数据，未接 D1 API。
- 旅行地图仍为矩形占位路径，未接入真实中国省级 SVG。
- 分类页阅读数使用 `mockViews`，未接 `post_views`（该表尚未落库）。
- Hero 视频存在占位说明：`public/media/hero-fallback-video.webm`。
- 素材规格与需求文档目标不一致（当前大部分为 `1024x1024 PNG`，需求要求 `1200x800` 或 `1920x1080`）。

---

## 3. 总体架构设计

### 3.1 架构分层

- 展示层：Astro 页面 + React 交互组件
- 接口层：Astro API Routes（公开接口 + 管理员接口）
- 领域层：`src/lib/*`（DB 查询与业务规则）
- 数据层：Cloudflare D1
- 媒体层：`public/` 静态资源 + 可选外置 Image Store

### 3.2 请求链路

1. 浏览器请求页面（SSR / SSG）。
2. Astro 页面读取内容集合或调用 D1 领域函数。
3. 敏感管理路由经 `src/middleware.ts` 校验 `oc_admin_token`。
4. API 统一返回 `{ ok, data | error }` JSON 结构。

### 3.3 路由拓扑

- 前台页面：`src/pages/index.astro`、`src/pages/tech/index.astro`、`src/pages/learning/index.astro`、`src/pages/life/index.astro`
- 文章详情：`src/pages/posts/[...slug].astro`
- 公开 API：`/api/travel`、`/api/social-graph`、`/api/highlights`
- 后台页面：`src/pages/admin/*`
- 管理 API：`src/pages/api/admin/*`

---

## 4. 数据模型设计

### 4.1 已有表（落地）

- `posts`
- `diary_entries`
- `timeline_nodes`
- `travel_places`
- `social_friends`
- `highlight_stages`
- `highlight_items`

### 4.2 建议新增表（用于需求补齐）

### `post_views`

用途：分类页“阅读最多”排序、文章页阅读统计。

```sql
CREATE TABLE IF NOT EXISTS post_views (
  id         INTEGER PRIMARY KEY AUTOINCREMENT,
  slug       TEXT NOT NULL,
  views      INTEGER NOT NULL DEFAULT 0,
  updated_at TEXT DEFAULT (datetime('now')),
  UNIQUE(slug)
);

CREATE INDEX IF NOT EXISTS idx_post_views_views ON post_views(views DESC);
```

### `admin_logs`（可选）

用途：后台仪表盘“最近动态”真实化。

```sql
CREATE TABLE IF NOT EXISTS admin_logs (
  id         INTEGER PRIMARY KEY AUTOINCREMENT,
  action     TEXT NOT NULL,
  payload    TEXT,
  created_at TEXT DEFAULT (datetime('now'))
);
```

---

## 5. API 设计

### 5.1 公开接口

- `GET /api/travel`
  - 返回按省聚合的城市足迹
- `GET /api/social-graph`
  - 返回匿名化社交图谱数据（仅 `public_label`）
- `GET /api/highlights`
  - 返回分阶段高光成就

### 5.2 管理接口

- 鉴权：`/api/admin/*` 统一走 `middleware` + JWT Cookie
- 已有模块：
  - 文章：`/api/admin/posts/*`
  - 时间线：`/api/admin/timeline/*`
  - 旅行：`/api/admin/travel/*`
  - 社交：`/api/admin/social/*`
  - 高光：`/api/admin/highlights/*`
  - 日记：`/api/admin/diary/*`
  - 图片：`/api/admin/images`

### 5.3 建议新增接口

- `POST /api/posts/[slug]/view`
  - 幂等地递增阅读计数（按会话/时间窗限流）
- `GET /api/home`
  - 一次性返回首页 Section2-6 所需聚合数据，减少客户端多次请求

---

## 6. 页面技术方案

### 6.1 首页 `/`

现状：结构完整，数据主要为静态常量。

目标改造：

- Hero
  - 保留 `CloudScene + video + image fallback` 三层降级
  - 正式资源：`/media/hero-fallback-video.webm`、`/media/hero-fallback.webp`
- 人生足迹（Section2）
  - 数据源改为 `timeline_nodes`
  - `type=reflection` 保持菱形视觉
- 高光时刻（Section3）
  - 数据源改为 `highlight_stages + highlight_items`
- 旅行足迹（Section4）
  - 数据源改为 `travel_places`
  - 地图改为真实省级路径 SVG
- 社交图谱（Section5）
  - 访客调用 `/api/social-graph`
  - 管理员调用 `/api/admin/social-graph`
- 数据面板（Section6）
  - 保持构建时统计 + 可选补充 D1 阅读数据

落地文件：

- `src/react/sections/HomePageExperience.tsx`
- `src/pages/index.astro`

### 6.2 分类页 `/tech/ /learning/ /life/`

- 现状：标签筛选、双列瀑布流、排序已完成。
- 改造点：
  - “阅读最多”排序改接 `post_views`
  - 封面图统一走生产素材目录，不再依赖临时占位
- 落地文件：
  - `src/pages/tech/index.astro`
  - `src/pages/learning/index.astro`
  - `src/pages/life/index.astro`
  - `src/react/sections/CategoryMasonry.tsx`

### 6.3 文章详情页 `/posts/[slug]/`

- 保持现有阅读进度、目录高亮、封面视差。
- 增加阅读计数上报（`POST /api/posts/[slug]/view`）。
- 封面图替换为规范素材路径，保留 blur reveal 交互。

### 6.4 全局组件

- 导航、页脚、宠物组件继续沿用：
  - `src/react/layout/Navbar.tsx`
  - `src/react/layout/Footer.tsx`
  - `src/components/BlogPet.astro`
- Logo 与图标统一走 `public/brand`、`public/icons`。

---

## 7. 素材接入规范

### 7.1 素材目录策略

- 原始素材：`assets/`
- 生产素材：`public/`
- 推荐生产目录：
  - `public/brand/`
  - `public/media/covers/{tech,learning,life}/`
  - `public/media/hero/`
  - `public/media/error/`

### 7.2 素材映射（本次输入）

| 需求项 | 源素材（assets） | 目标路径（public） | 状态 |
|---|---|---|---|
| 主 Logo | `logo-horizontal-azure.png` | `public/brand/logo-main.(svg或png)` | 可用，建议矢量化 |
| Logo 图标 | `logo-icon-azure.png` `logo-icon-ink.png` `logo-icon-white.png` | `public/brand/logo-icon.*` | 可用 |
| Hero fallback 图 | `hero-cloudscape-fallback.png` | `public/media/hero/hero-fallback.webp` | 待转码 |
| Hero fallback 视频 | `Hero_Background_Video_Generation.mp4` | `public/media/hero/hero-fallback-video.webm` | 待转码 |
| OG 图 | `og-social-cloudscape-card.png` | `public/media/og-cloudscape-card.png` | 可用 |
| 技术封面 | `cover-tech-*.png` | `public/media/covers/tech/*.webp` | 可用，需规格统一 |
| 效率封面 | `cover-efficiency-*.png` | `public/media/covers/learning/*.webp` | 可用，需规格统一 |
| 生活封面 | `cover-life-*.png` | `public/media/covers/life/*.webp` | 可用，需规格统一 |
| 404 插图 | `error-404-lost-sheep.png` | `public/media/error/404-lost-sheep.webp` | 可用 |
| 装饰插图 | `illustration-sheep-on-clouds.png` | `public/media/illustrations/sheep-on-clouds.webp` | 可用 |

### 7.3 规格要求

- 文章封面：`1200x800`，WebP，单图建议 `< 300KB`
- Hero 静态图：`1920x1080`，WebP，建议 `< 500KB`
- Hero 视频：WebM(H.264/VP9)，10-15s 循环，建议 `< 4MB`
- OG 图：`1200x630` PNG

### 7.4 资源处理流程

1. 从 `assets/` 选图。
2. 统一裁切到目标比例。
3. 转码为 WebP/WebM。
4. 写入 `public/` 并替换页面引用。
5. 校验首屏 LCP 与包体。

---

## 8. 性能与稳定性

- 首屏策略：Hero 视频失败自动回退图片；`prefers-reduced-motion` 关闭重动画。
- 图片策略：
  - 首屏关键图 `fetchpriority="high"`
  - 其余 `loading="lazy"`
- 动画策略：限制高成本滤镜与阴影叠加层数。
- API 策略：首页聚合接口 + 数据缓存（Cloudflare edge cache 可选）。

---

## 9. 安全与隐私

- 管理端基于 `oc_admin_token`（httpOnly） + `ADMIN_JWT_SECRET` 校验。
- 社交图谱公开接口严禁返回 `name/link/avatar`。
- 管理 API 统一参数校验与错误码。
- Markdown 渲染建议补充 XSS 过滤（尤其后台预览链路）。

---

## 10. 分阶段实施计划

### Phase 1（素材落库）

- 将 `assets/` 关键素材转码并接入 `public/`。
- 替换当前 placeholder 资源引用。
- 输出素材清单与引用清单。

交付物：视觉可上线版本（不含数据动态化）。

### Phase 2（首页动态数据化）

- 首页 Section2-5 改为 API/D1 驱动。
- 引入真实省级地图路径。
- 管理端数据变更实时反映首页。

交付物：首页从“静态样例”变为“可运营页面”。

### Phase 3（阅读统计与内容增长能力）

- 落库 `post_views`。
- 分类页“阅读最多”与文章阅读计数打通。
- 增加基础防刷策略。

交付物：内容数据闭环。

### Phase 4（性能与验收）

- LCP、CLS、JS 体积优化。
- 手动回归：前台核心路径 + 后台 CRUD 全链路。
- 生产部署与回滚预案验证。

交付物：可稳定发布版本。

---

## 11. 验收标准（DoD）

- 首页七段均使用真实数据（非硬编码数组）。
- 素材全部替换为生产资源，路径与命名符合规范。
- 社交图谱访客态不暴露真实身份信息。
- 后台六模块 CRUD 可用，错误提示可读。
- 分类页排序中“阅读最多”基于真实计数。
- `npm run build` 与 `npm run preview` 通过。

---

## 12. 发布与运维

- 本地验证：
  - `npm run build`
  - `npm run preview`
- D1 迁移：
  - `wrangler d1 migrations apply <db-name> --remote`
- 密钥检查：
  - `ADMIN_PASSWORD`
  - `ADMIN_JWT_SECRET`
  - `IMAGE_STORE_API_KEY`

---

## 13. 关键文件清单

- 需求文档：`assets/博客需求文档.md`
- 本文档：`assets/博客技术文档.md`
- 首页实现：`src/react/sections/HomePageExperience.tsx`
- 分类实现：`src/react/sections/CategoryMasonry.tsx`
- 文章布局：`src/layouts/PostLayout.astro`
- 管理后台：`src/pages/admin/*`
- 管理 API：`src/pages/api/admin/*`
- 公开 API：`src/pages/api/travel.ts`、`src/pages/api/social-graph.ts`、`src/pages/api/highlights.ts`
- 数据迁移：`migrations/*.sql`

