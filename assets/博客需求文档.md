# openingClouds 博客设计文档 & 素材需求

> 本文档完整记录博客的设计体系、页面结构和视觉元素，用于确认需要 AI 生成的图片、视频、图标等素材清单。

---

## 十、GitHub 参考仓库（2026-02-13 更新）

> 目标：为博客各系统提供可复用的实现参考，按系统分组管理，统一浅克隆到 `references/github/`。

### 10.1 宠物系统

| 仓库 | 链接 | 用途 | 对应模块 |
|------|------|------|---------|
| `adryd325/oneko.js` | https://github.com/adryd325/oneko.js | oneko 原始追踪逻辑（MIT） | `src/components/BlogPet.astro` 动作状态机 |
| `kyrie25/spicetify-oneko` | https://github.com/kyrie25/spicetify-oneko | oneko 精灵图来源（MIT） | `public/pets/` 皮肤与动作帧参考 |

### 10.2 视觉与交互参考仓库

#### Three.js 动态系统

| 仓库 | 链接 | 用途 | 对应模块 |
|------|------|------|---------|
| `pmndrs/react-three-fiber` | https://github.com/pmndrs/react-three-fiber | Three.js React 渲染基础 | Hero 云海穿越 |
| `pmndrs/drei` | https://github.com/pmndrs/drei | `Cloud` / `Sparkles` 等辅助组件 | Hero 云层与粒子 |

#### 动画系统

| 仓库 | 链接 | 用途 | 对应模块 |
|------|------|------|---------|
| `motiondivision/motion` | https://github.com/motiondivision/motion | Framer Motion 页面与卡片动效 | 全局 Stagger / Reveal / Hover / AnimatePresence |

#### 时间线组件

| 仓库 | 链接 | 用途 | 对应模块 |
|------|------|------|---------|
| `prabhuignoto/react-chrono` | https://github.com/prabhuignoto/react-chrono | 现代时间线组件（水平/垂直/树形） | Section 2 人生足迹时间轴布局参考 |
| `stephane-monnot/react-vertical-timeline` | https://github.com/stephane-monnot/react-vertical-timeline | 垂直时间线组件 | Section 2 人生足迹、后管时间线编辑视图参考 |

#### 社交图谱系统

| 仓库 | 链接 | 用途 | 对应模块 |
|------|------|------|---------|
| `vasturiano/react-force-graph` | https://github.com/vasturiano/react-force-graph | 力导向关系图（2D/3D） | Section 5 社交图谱 |
| `vasturiano/r3f-forcegraph` | https://github.com/vasturiano/r3f-forcegraph | R3F 集成版力导向图 | 社交图谱 R3F 方案备选 |

#### 地图系统

| 仓库 | 链接 | 用途 | 对应模块 |
|------|------|------|---------|
| `apache/echarts` | https://github.com/apache/echarts | 地图底图与可视化能力 | Section 4 旅行足迹中国地图 |
| `longwosion/geojson-map-china` | https://github.com/longwosion/geojson-map-china | 中国省级/市级 GeoJSON 数据 | 旅行足迹地图省份轮廓数据源 |

#### 图标系统

| 仓库 | 链接 | 用途 | 对应模块 |
|------|------|------|---------|
| `lucide-icons/lucide` | https://github.com/lucide-icons/lucide | 线性 SVG 图标体系 | 导航/面板/联系方式/分类图标 |

### 10.3 后管系统

| 仓库 | 链接 | 用途 | 对应模块 |
|------|------|------|---------|
| `clauderic/dnd-kit` | https://github.com/clauderic/dnd-kit | 拖拽排序 | 时间线/高光时刻重排序 (`/admin/timeline`, `/admin/highlights`) |
| `uiwjs/react-md-editor` | https://github.com/uiwjs/react-md-editor | Markdown 编辑器参考 | 文章编辑器 (`/admin/posts`) |

### 10.4 本地已 clone 仓库（共 17 个）

> 本地目录：`references/github/`
> 克隆脚本：`scripts/clone-reference-repos.sh`（`--depth 1` 浅克隆）

| # | 仓库 | GitHub | 本地路径 | 系统分类 |
|---|------|--------|---------|---------|
| 1 | `oneko.js` | https://github.com/adryd325/oneko.js | `references/github/oneko.js` | 🐑 宠物系统 |
| 2 | `spicetify-oneko` | https://github.com/kyrie25/spicetify-oneko | `references/github/spicetify-oneko` | 🐑 宠物系统 |
| 3 | `react-three-fiber` | https://github.com/pmndrs/react-three-fiber | `references/github/react-three-fiber` | 🌐 Three.js |
| 4 | `drei` | https://github.com/pmndrs/drei | `references/github/drei` | 🌐 Three.js |
| 5 | `motion` | https://github.com/motiondivision/motion | `references/github/motion` | 🎞️ 动画系统 |
| 6 | `react-chrono` | https://github.com/prabhuignoto/react-chrono | `references/github/react-chrono` | 🛤️ 时间线组件 |
| 7 | `react-vertical-timeline` | https://github.com/stephane-monnot/react-vertical-timeline | `references/github/react-vertical-timeline` | 🛤️ 时间线组件 |
| 8 | `echarts` | https://github.com/apache/echarts | `references/github/echarts` | 🗺️ 地图系统 |
| 9 | `geojson-map-china` | https://github.com/longwosion/geojson-map-china | `references/github/geojson-map-china` | 🗺️ 地图系统 |
| 10 | `react-force-graph` | https://github.com/vasturiano/react-force-graph | `references/github/react-force-graph` | 👥 社交图谱 |
| 11 | `r3f-forcegraph` | https://github.com/vasturiano/r3f-forcegraph | `references/github/r3f-forcegraph` | 👥 社交图谱 |
| 12 | `lucide` | https://github.com/lucide-icons/lucide | `references/github/lucide` | 🎨 图标系统 |
| 13 | `dnd-kit` | https://github.com/clauderic/dnd-kit | `references/github/dnd-kit` | 🔧 后管系统 |
| 14 | `react-md-editor` | https://github.com/uiwjs/react-md-editor | `references/github/react-md-editor` | 🔧 后管系统 |
| 15 | `openingcloud-blog` | https://github.com/hqy2020/openingcloud-blog | `references/github/openingcloud-blog` | 📦 个人仓库 |
| 16 | `GardenOfOpeningClouds` | https://github.com/hqy2020/GardenOfOpeningClouds | `references/github/GardenOfOpeningClouds` | 📦 个人仓库 |
| 17 | `hqy2020` | https://github.com/hqy2020/hqy2020 | `references/github/hqy2020` | 📦 个人仓库 |

---

## 一、品牌定位

| 属性 | 内容 |
|------|------|
| 博客名 | **openingClouds**（启云） |
| 定位 | 个人技术博客 + 生活记录 + 成长轨迹 |
| Favicon | ☁️ 云朵 emoji |
| 口号 | "Tech · Efficiency · Life" |
| 核心视觉意象 | **天空、云朵、牧场、绵羊** — 干净、轻盈、有温度 |
| 三大分类 | 💻 技术、📚 效率、📷 生活 |

---

## 二、色彩系统 — "霞墨 Mist & Ink"

> 详细设计文档见 `配色系统重设计-霞墨.md`

### 设计理念

- **霞** — 黄昏天色，非正午纯蓝，带紫调的柔和天光
- **墨** — 水墨深邃，暗部带蓝紫底色，书卷气的厚重感
- 保留 "clouds/天空" 品牌意象，但从"正午明亮"转向"黄昏沉静"

### 色彩架构

| 色族 | 用途 | 核心色值 | 视觉感受 |
|------|------|---------|---------|
| **靛蓝 (Azure)** | 品牌主色、CTA、链接 | `#4F6AE5` | 沉稳、深邃、黄昏天空 |
| **青灰 (Sage)** | 技术分类 | `#6B917B` | 雨后青苔、冷静、专业 |
| **琥珀 (Amber)** | 效率分类 | `#B8945E` | 老式铜器、温润、有分量 |
| **雾紫 (Mauve)** | 生活分类 | `#9684A8` | 薰衣草干花、柔和、私密 |
| **墨灰 (Ink)** | 中性底色、文字、边框 | `#1A1D2E` / `#EAECF2` | 水墨宣纸、有温度 |

### 暗黑模式

- 浅色底：`#F8F9FC`（微蓝纸白），深色底：`#0B0E18`（墨紫夜空）
- 所有灰色 hue 统一 230-240°（蓝紫区间），形成"墨"的调性
- Aurora 光效 opacity 降至 5-8%（比旧版更克制）

---

## 三、字体系统

| 字体 | 用途 | 说明 |
|------|------|------|
| **LXGW WenKai**（霞鹜文楷） | 标题、hero 大字、导航 | 中文手写感衬线体，品牌标识 |
| **PingFang SC** | 正文、段落 | 系统默认，清晰易读 |
| **JetBrains Mono** | 代码块、技术内容 | 等宽字体 |

---

## 四、页面结构与板块详解

### 4.1 首页 (`/`) — "云海穿越"

首页采用**全宽沉浸式**设计，无侧边栏，由七大板块 + 六条风格线过渡组成，整体风格从"可爱绵羊"转向**气势磅礴的云海穿越体验**。

```
┌─────────────────────────────────────────┐
│  Section 1: HERO — 云海穿越             │
│  Three.js 全屏 + 品牌名 + 滚动 Slogan   │
│  100vh                                  │
├─────── ☁️ 云浪风格线 ─────────────────────┤
│  Section 2: 人生足迹 — 进度条            │
│  水平时间轴 · 出生→现在→未来             │
├─────── 〰️ 波纹风格线 ─────────────────────┤
│  Section 3: 高光时刻                     │
│  6 张里程碑卡片 · 非线性布局              │
├─────── 🌊 潮汐风格线 ─────────────────────┤
│  Section 4: 旅行足迹 — 去过的地方         │
│  中国地图 + 城市标记 · 旅行记忆卡片       │
├─────── 🏔️ 山脊风格线 ─────────────────────┤
│  Section 5: 社交好友                     │
│  好友头像卡片 · 链接到他们的世界          │
├─────── ✦ 星尘风格线 ──────────────────────┤
│  Section 6: 数据面板                     │
│  文章数 · 总字数 · 分类统计 · 标签数      │
├─────── ∿ 流线风格线 ──────────────────────┤
│  Section 7: 联系方式                     │
│  邮箱 + GitHub · 极简结尾               │
└─────────────────────────────────────────┘
```

---

#### Section 1：Hero — 云海穿越（100vh）

**Three.js 场景设计：**

核心效果 — 相机在云海中缓慢穿行，远处有一束光透过云缝照射下来，营造"拨云见日"的气势。

```
Camera (缓慢向前 z-0.015/frame)
├── Fog (near: 3, far: 15, color: #0B0E18 / #F8F9FC)
├── CloudLayer × 6-8 组
│   ├── 每组 3-5 个 drei <Cloud />
│   ├── 分布在 x: [-8, 8], y: [-2, 3], z: [-20, 5]
│   ├── 当 cloud.z > camera.z + 3 时回收到最远处
│   └── opacity 0.15-0.35, speed 0.05-0.2
├── GodRay 光柱
│   ├── 1 个 SpotLight (从上方照射)
│   ├── 2-3 个半透明 PlaneGeometry 模拟体积光
│   └── 旋转 + 脉动动画
├── Particles (微尘/星辰)
│   ├── drei <Sparkles /> count={80} size={1.5}
│   └── 或 custom Points buffer geometry
└── Ambient + Hemisphere light
```

**性能考量：**
- `dpr={[1, 1.5]}`，移动端降至 1
- Cloud 数量响应式：桌面 8 组，移动 4 组
- `useReducedMotion` fallback：静态渐变背景

**前景内容：**

```
┌──────────────────────────────┐
│   openingClouds              │  ← 品牌名，LXGW WenKai
│   "Clouds" 带 azure 渐变     │
├──────────────────────────────┤
│   ▲ 滚动 Slogan 区域         │  ← 垂直 marquee 动画
│   "用代码丈量世界"            │     每 4s 切换一句
│   ▼                          │     淡入淡出过渡
├──────────────────────────────┤
│   Tech · Efficiency · Life   │  ← 副标题标签
└──────────────────────────────┘
         SCROLL ↓                   ← 浮动指示器
```

**Slogan 列表（6-8 条垂直滑动轮播）：**
- "用代码丈量世界的边界"
- "记录即存在，分享即生长"
- "每一次优化都是向自由迈进"
- "在云端看自己的脚印"
- "技术是手段，思考是目的"
- "把日常过成实验，把生活活成作品"

**Slogan 动画：** 垂直滑动 + 淡入淡出（非打字机，更磅礴），4s 间隔。

**🎨 需要的素材：**
- [ ] 品牌 Logo 图片（目前只有 ☁️ emoji favicon）
- [ ] Hero 背景 fallback：一张高品质云海/天空全景图（3D 不可用时使用）
- [ ] 品牌 OG 图片（社交媒体分享时显示）

---

#### 风格线 — 板块间的流畅过渡

每个风格线都是一个独立的 SVG 组件，宽度 100vw，高度 80-120px，使用贝塞尔曲线模拟云雾/波浪形态。

```
variant="cloud":  ╭─────╮    ╭──╮       ← 云朵轮廓（Hero→足迹）
                 ─╯     ╰────╯  ╰───

variant="wave":   ～～～～～～～～～～     ← 正弦波（足迹→高光）

variant="tide":   ▁▂▃▄▅▆▇█▇▆▅▄▃▂▁      ← 潮汐渐变（高光→旅行）

variant="ridge":  ╱╲╱╲  ╱╲    ╱╲╱╲     ← 山脊轮廓（旅行→好友）

variant="dust":   · ✦ · · ✦ · ✦ · ·    ← 星尘散点（好友→数据）

variant="flow":   ╲  ╱╲  ╱╲  ╱╲  ╱     ← 流线（数据→联系）
```

**实现方式：**
- SVG `<path>` 手绘贝塞尔曲线
- fill 使用上下 section 的背景色过渡
- 可选 CSS animation 让曲线微微浮动（`translateX` 循环）
- Dark mode 颜色同步切换

---

#### Section 2：人生足迹 — 进度条

水平时间轴，从出生到现在的人生阶段，共 13 个节点。

```
2000 ── 2006 ── 2012 ── 2016 ── 18' ── 2019 ── 2020 ── 2022 ── 2024 ── 25' ── 2026 ──> 未来
 ○       ○       ○       ○      ◇      ○       ○       ○       ○      ◇      ●
出生    小学    初中    高中   沉淀    同济    恋爱    蔚来    SAP/浙大 沉淀   博客   ⬤ 脉动
 🏠     📚      📚      📚    🌧️     📚🎓    🏠❤️    💼      💼📚   🌧️     💼
```

**完整时间线数据（13 个节点）：**

| # | start_date | end_date | title | type | impact | description |
|---|-----------|----------|-------|------|--------|-------------|
| 1 | 2000-09 | — | 出生 | family | medium | 时间线起点 |
| 2 | 2006-09 | 2012-07 | 凉城三小 · 小学 | learning | medium | |
| 3 | 2012-09 | 2016-07 | 扬波中学 · 初中 | learning | medium | |
| 4 | 2016-09 | 2019-07 | 交大附中嘉定分校 · 高中 | learning | medium | |
| 4.5 | 2018-12 | 2019-01 | 暗夜与破晓 | reflection | — | 高三的漫长冬天，也是黎明前最深的夜 |
| 5 | 2019-09 | 2023-07 | 同济大学 · 本科 | learning | **high** | |
| 6 | 2020-11 | — | 和杨彩确定恋爱关系 | family | **high** | |
| 7 | 2022-11 | 2023-05 | 蔚来实习 | career | medium | |
| 8 | 2024-06 | 2024-09 | SAP 实习 | career | medium | |
| 9 | 2024-09 | 2026-03 | 浙江大学 · 硕士 | learning | **high** | |
| 10 | 2025-04 | 2025-06 | 阿里云实习 | career | **high** | |
| 10.5 | 2025-04 | 2025-10 | 云层之下 | reflection | — | 走过一段看不见天空的路，但脚步没有停 |
| 11 | 2026-02 | — | 开始系统整理博客 | career | medium | |

**视觉规格：**
- 已走过的部分：azure-500 实线（2px）
- 未走过的部分：ink-300 虚线
- 当前位置：azure-500 脉动圆点（pulse animation）
- 每个节点：圆点 + 年份 + 标题
- 节点 hover：展开描述卡片（motion.div 弹出）
- `impact=high` 的节点圆点更大、带 glow 光效
- `type=reflection` 的节点：菱形 ◇（非圆形）、ink-400 低饱和色、hover 描述用斜体呈现，不抢视觉焦点但真实存在

**动画：**
- ScrollReveal 触发：进度条从左向右"绘制"（`scaleX 0→1`，origin-left）
- 节点依次弹出（StaggerItem）
- 使用 `useInView` 触发一次

**数据来源：** 数据库 `timeline_nodes` 表（SSR）或静态数据 fallback

---

#### Section 3：人生高光时刻

展示人生各阶段的关键成就，非线性错位布局。

**完整高光成就列表（按人生阶段）：**

| 阶段 | 高光成就 |
|------|---------|
| **小学** | 三年大队长；800 米虹口区第二 |
| **初中** | 班长、大队长；校 800 米第一 |
| **高中** | 生物/地理课代表；1000m 校记录 |
| **高考** | 575 分，全市 2000 多名 |
| **同济大学 · 本科** | 优秀学生、优秀学生干部；学生会主席；志愿者中队负责人；中共党员；年级 15；上海市优秀毕业生；优秀毕业论文；第四、五届进博会志愿者；和老婆恋爱 |
| **浙江大学 · 硕士** | CCF-B 一作；CCF-A 二作；两篇专利；一篇期刊在投；浙江大学优秀毕业生；优秀研究生 |

**卡片布局（6 张大卡片）：**

```
┌─────────────────────────┐  ╭─────────────────────┐
│  📚 小学 · 初中 · 高中    │  │ 🎓 高考 575 分       │ ← translate-y 错位
│  大队长 / 校800第一 /     │  │ 全市 2000 多名        │
│  1000m校记录             │  │ [learning] [high]    │
│  [learning] [high]      │  ╰─────────────────────╯
└─────────────────────────┘
         ╭───────────────────────┐  ╭──────────────────┐
         │  📚 2019-09 → 2023-07 │  │ 🏠 2020-11       │
         │  同济大学 · 本科        │  │ 和杨彩确定恋爱关系  │
         │  学生会主席 / 优秀毕业生 │  │ [family] [high]  │
         │  [learning] [high]    │  ╰──────────────────╯
         ╰───────────────────────┘
┌───────────────────────────────┐  ╭──────────────────┐
│  📚 2024-09 → 2026-03         │  │ 💼 2025-04       │
│  浙江大学 · 硕士               │  │ 阿里云实习        │
│  CCF-B 一作 / CCF-A 二作 /    │  │ [career] [high]  │
│  优秀毕业生                    │  ╰──────────────────╯
│  [learning] [high]           │
└───────────────────────────────┘
```

**视觉规格：**
- 12 列网格，卡片大小不一（col-span-7 / col-span-5 / col-span-8 等）
- 每张卡片：玻璃态 + CardSpotlight 鼠标跟踪光效
- 非线性 translateY 错位
- 可选封面图（从 timeline_nodes.cover）
- impact 高的卡片更大、border 更明显
- FadeIn + StaggerContainer 入场

**数据来源：** 数据库 `timeline_nodes` 表，筛选 `impact = 'high'` 的节点 + 静态高光成就数据

---

#### Section 4：旅行足迹 — 去过的地方

全宽中国地图，去过的省份点亮，城市标记悬浮卡片。

```
┌──────────────────────────────────────────────────────┐
│  🗺️ 我去过的地方                     已点亮 X / 34 省 │
│                                                      │
│         ┌─────────────────────────────────┐          │
│         │          ██ 黑龙江               │          │
│         │    ██                            │          │
│         │  新疆    ██ 内蒙古     ·北京      │          │
│         │         ██          ★上海        │          │
│         │    ██  ██ ██                     │          │
│         │       四川  ██  ██               │          │
│         │         ██ ██  ██ ★杭州         │          │
│         │    ██    ██  ██                  │          │
│         │  云南  贵州  ██  ██ 福建          │          │
│         │              广东                │          │
│         │         ██  海南                 │          │
│         └─────────────────────────────────┘          │
│                                                      │
│    hover 省份 →  ╭──────────────────────╮             │
│                  │ 📍 浙江省             │             │
│                  │ 杭州 · 2024至今 · 求学 │             │
│                  │ 宁波 · 2025 · 旅行    │             │
│                  ╰──────────────────────╯             │
└──────────────────────────────────────────────────────┘
```

**地图设计：**
- SVG 中国地图（省级轮廓），全宽居中展示
- **点亮逻辑**：去过的省份填充 azure-400/500 渐变，未去过 ink-100（浅色）/ ink-800（暗色）
- 当前所在省份：azure-500 + 脉动边框（pulse）
- 城市用圆点 `●` 标记在省份内，当前所在城市 `★`
- 右上角统计徽章："已点亮 X / 34 省级行政区"

**省份 Hover 浮窗：**
- 悬浮在鼠标位置附近的玻璃态卡片
- 显示：省名 + 该省去过的所有城市列表
- 每个城市一行：城市名 · 时间 · 标签（求学/工作/旅行/生活）
- 未去过的省份 hover 只显示省名 + "尚未探索"

**数据格式（静态 JSON）：**

```ts
interface TravelPlace {
  province: string       // 省份名（匹配 SVG path id）
  cities: {
    name: string         // 城市名
    period: string       // 时间段
    tag: '求学' | '工作' | '旅行' | '生活'
    current?: boolean    // 是否当前所在
  }[]
}
```

**动画：**
- ScrollReveal 触发地图整体淡入
- 省份高亮依次点亮（StaggerItem，从上海→周边省份向外扩散，模拟足迹蔓延）
- 统计数字 AnimatedNumber 递增

**🎨 需要的素材：**
- [ ] SVG 中国地图（省级轮廓，可用开源 SVG 底图如 echarts/map）

---

#### Section 5：社交图谱 — 我的人际星图

Obsidian 风格的力导向关系图，人生阶段为大节点，朋友为小节点。**隐私分层：只有管理员登录后能看到名字，访客只看到匿名光点。**

```
┌──────────────────────────────────────────────────────────┐
│  🌐 人际星图                                              │
│                                                          │
│           ·                                              │
│         · · ·                                            │
│          ╲│╱                                             │
│    · ── [小学] ──────────── [初中] ── ·                    │
│            ╲                 ╱  ╲  ·                      │
│             ╲               ╱    · ·                      │
│         · ── [高中] ── [同济] ── ·                         │
│                ·        ╱╲    · · ·                       │
│               · ·      ╱  ╲  ·                            │
│                  [浙大] ── [工作]                           │
│                 ╱ ╲ ╲      ╱╲                             │
│                · · · ·    · · ·                            │
│                                                          │
│     ● 人生阶段    · 朋友（hover 查看）    ── 链接           │
│                                                          │
│        "每个阶段都有照亮过彼此的人"                          │
└──────────────────────────────────────────────────────────┘

  管理员视角（登录后）：              访客视角：
  · → "张三" + 头像 + 链接           · → 匿名光点（无信息）
  hover 显示完整信息                 hover 显示 "一位老友" / "一位同学"
```

**图谱设计：**
- **力导向布局**（D3 force-simulation 或 react-force-graph）
- **大节点**（人生阶段）：小学、初中、高中、同济、浙大、工作（蔚来/SAP/阿里云）
  - 尺寸 40-50px，阶段名称标签始终可见
  - 颜色按 type 映射：learning → sage，career → azure，family → mauve
  - 阶段之间有细线相连（时间线序）
- **小节点**（朋友）：链接到所属阶段
  - 尺寸 8-12px，ink-300 低饱和圆点
  - 自然散布在大节点周围，物理弹簧力布局
  - 同一阶段的朋友节点颜色一致（跟随阶段色，但更淡）

**隐私分层机制：**

| 状态 | 小节点显示 | Hover 信息 | 点击行为 |
|------|-----------|-----------|---------|
| **访客**（默认） | 匿名光点 `·` | 模糊称呼："一位挚友"/"一位同窗"/"一位战友" | 无操作 |
| **管理员**（JWT 登录） | 带颜色光点 + 名字首字 | 完整信息：名字 + 一句话 + 外链 | 新窗口打开好友主页 |

- 判断依据：检测 `oc_admin_token` cookie 是否有效
- 前端渲染：数据中始终包含 `publicLabel`（模糊称呼），`name`/`link` 等敏感字段通过 API 按登录态返回
- **不登录时不暴露任何真实信息**，图谱仍然美观完整

**数据格式：**

```ts
interface SocialNode {
  id: string
  type: 'stage' | 'friend'
}

interface StageNode extends SocialNode {
  type: 'stage'
  label: string            // "同济大学"
  period: string           // "2019-2023"
  category: 'learning' | 'career' | 'family'
}

interface FriendNode extends SocialNode {
  type: 'friend'
  stageId: string          // 所属阶段
  publicLabel: string      // 访客看到的称呼："一位挚友"
  // ↓ 以下字段仅管理员 API 返回
  name?: string            // 真实名字
  bio?: string             // 一句话
  link?: string            // 主页链接
  avatar?: string          // 头像 URL
}
```

**API 设计：**
- `GET /api/social-graph` — 返回公开图谱（只有 stage 节点 + 匿名 friend 节点）
- `GET /api/admin/social-graph` — 管理员接口，返回完整数据（需 JWT）
- 前端根据登录态选择调用哪个接口

**交互：**
- 图谱可拖拽平移，大节点可拖动（朋友节点跟随弹簧力重新布局）
- 鼠标 hover 小节点：访客看模糊称呼气泡，管理员看完整卡片
- 大节点 hover：高亮该阶段所有朋友节点 + 连线
- 整体缓慢呼吸浮动（idle 动画），节点微微漂移

**动画：**
- ScrollReveal 触发图谱淡入
- 大节点先出现（从左到右按时间序 StaggerItem）
- 小节点随后从大节点中心 burst 弹出散开
- idle 状态：节点微微浮动（sin 波 + 随机偏移）

**🎨 需要的素材：**
- [ ] 好友头像（管理员视角使用，由各好友提供或 AI 生成）

---

#### Section 6：数据面板

4 个核心数据卡片 + 分类小统计。

```
┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐
│  ✍️      │  │  📝     │  │  🏷️     │  │  📅     │
│  23      │  │  48,000 │  │  35     │  │  180    │
│  篇文章   │  │  总字数  │  │  个标签  │  │  天     │
└─────────┘  └─────────┘  └─────────┘  └─────────┘

     技术 12 篇  ·  效率 6 篇  ·  生活 5 篇
```

**视觉规格：**
- 4 列网格（移动 2 列）
- 每个数据卡：AnimatedNumber 递增动画（滚动进入视口时触发）
- 底部一行分类统计（小字，居中）
- CardSpotlight 光效
- FadeIn 入场

**数据计算（构建时）：**
- 总文章数：遍历所有 content collection
- 总字数：中文字符 + 英文单词计数
- 标签数：去重后的 tag 集合
- 天数：首篇文章至今的天数
- 分类统计：tech / learning / life 各自的文章数

---

#### Section 7：联系方式

极简底部区域，品牌气质收尾。与 Footer 合并，首页不再单独显示 Footer。

```
┌─────────────────────────────────────────┐
│              Let's Connect              │
│                                         │
│     ┌──────────┐    ┌──────────┐       │
│     │  ✉️ Email │    │  🐙 GitHub│       │
│     │  复制邮箱  │    │  @hqy2020 │       │
│     └──────────┘    └──────────┘       │
│                                         │
│         © 2025 openingClouds            │
│         Built with Astro                │
└─────────────────────────────────────────┘
```

**交互：**
- Email 卡片点击：复制到剪贴板 + toast 提示
- GitHub 卡片点击：新窗口打开
- hover：卡片微上升 + glow

**🎨 需要的素材：**
- [ ] 数据面板图标（可选替换 emoji ✍️📝🏷️📅 为自定义 SVG）
- [ ] 联系方式图标（邮箱、GitHub，可用 SVG 线性图标）
- [ ] 人生高光封面图（3-5 张，关键人生节点的纪念图片/插画，800×600px）

---

### 4.2 分类列表页 (`/tech/`、`/learning/`、`/life/`)

三个分类页**统一布局和动画**，仅通过主色区分身份。小红书风格双列瀑布流 + 标签筛选。

**分类配色映射：**

| 分类 | 主色 | 渐变 | 标签高亮 |
|------|------|------|---------|
| 技术 `/tech/` | sage `#6B917B` | sage-400 → sage-600 | sage-100 bg |
| 效率 `/learning/` | amber `#B8945E` | amber-400 → amber-600 | amber-100 bg |
| 生活 `/life/` | mauve `#9684A8` | mauve-400 → mauve-600 | mauve-100 bg |

---

#### ① 页面头部

```
┌──────────────────────────────────────────────────────┐
│  ╭─ BackgroundBeams 光束（分类主色）──────────────╮   │
│  │                                                │   │
│  │     💻 技术                                    │   │
│  │     探索代码世界的边界                           │   │
│  │     12 篇文章 · 48,000 字                      │   │
│  │                                                │   │
│  ╰────────────────────────────────────────────────╯   │
└──────────────────────────────────────────────────────┘
```

- 全宽圆角玻璃态容器
- BackgroundBeams 光束动画，颜色跟随分类主色
- 分类图标 + 分类名 + 一句话描述 + 文章数/字数统计
- FadeIn 入场

---

#### ② 标签筛选栏

```
┌──────────────────────────────────────────────────────┐
│  全部(12)  Java(5)  并发(4)  Spring(3)  Docker(2) ...│
│  ─────                                               │
│  ↑ 当前选中：下划线 + 主色文字                          │
│                                                      │
│  排序：最新优先 ↕                                      │
└──────────────────────────────────────────────────────┘
```

- 水平滚动标签栏（移动端可左右滑动）
- 每个标签显示文章数：`标签名(N)`
- 选中态：分类主色文字 + 底部 2px 下划线（motion layoutId 滑动过渡）
- "全部" 标签始终在最左，默认选中
- 右侧排序切换：最新优先（默认）/ 阅读最多
- 切换标签时文章列表 AnimatePresence 过渡（淡出旧 → 淡入新）

---

#### ③ 瀑布流文章列表（小红书风格）

```
┌──────────────────────────────────────────┐
│                                          │
│  ╭──────────────╮  ╭──────────────╮     │
│  │ ┌──────────┐ │  │              │     │
│  │ │  封面图   │ │  │ ┌──────────┐│     │
│  │ │ 16:9/4:3 │ │  │ │  封面图   ││     │
│  │ └──────────┘ │  │ │  1:1     ││     │
│  │  标题（两行） │  │ │          ││     │
│  │  2025-01-15  │  │ └──────────┘│     │
│  │  👁 128  3min │  │  标题       │     │
│  ╰──────────────╯  │  2025-02-01 │     │
│  ╭──────────────╮  │  👁 256 5min │     │
│  │              │  ╰──────────────╯     │
│  │ ┌──────────┐ │  ╭──────────────╮     │
│  │ │  封面图   │ │  │ ┌──────────┐ │     │
│  │ │ 3:4     │ │  │ │  封面图   │ │     │
│  │ │          │ │  │ │  16:9    │ │     │
│  │ └──────────┘ │  │ └──────────┘ │     │
│  │  标题        │  │  标题（两行） │     │
│  │  2024-12-20  │  │  2024-11-08  │     │
│  │  👁 89  4min  │  │  👁 312 7min │     │
│  ╰──────────────╯  ╰──────────────╯     │
│                                          │
│           ·  ·  · 加载更多 ·  ·  ·       │
└──────────────────────────────────────────┘
```

**瀑布流布局：**
- **双列** Masonry 布局（桌面和移动端统一双列，间距 12-16px）
- 卡片宽度相同，**高度由封面图比例决定**，自然错落
- 使用 CSS `columns: 2` 或 JS Masonry 计算（useMasonry hook）

**卡片设计：**

```
╭────────────────────╮
│ ┌────────────────┐ │
│ │                │ │  ← 封面图：保持原始比例裁切
│ │    封面图       │ │     无封面 → CoverFallback 组件
│ │                │ │     圆角 8px（顶部）
│ └────────────────┘ │
│  标题最多两行截断…   │  ← font-medium，LXGW WenKai
│                    │
│  2025-01-15        │  ← 日期 ink-400 小字
│  👁 128 · 3 min    │  ← 阅读数 + 阅读时长
╰────────────────────╯
     ↑ 圆角 12px，白底（暗色模式 ink-900）
       无边框，box-shadow 轻阴影
```

- 封面图保持原始宽高比（不强制裁切），自然撑开卡片高度
- 无封面文章：使用 CoverFallback 组件生成渐变+图标占位（比例 4:3）
- 标题最多两行，超出 `line-clamp-2` 截断
- 底部信息行：日期 + 阅读数（👁 图标）+ 预计阅读时长
- 卡片间距：列间 12px，行间 12px

**Hover 效果：**
- 卡片整体上浮 4px（translateY）
- box-shadow 加深
- 封面图微放大（scale 1.03，overflow hidden 裁切）
- 过渡 200ms ease-out

**阅读数来源：**
- 数据库 `post_views` 表记录每篇文章阅读数
- 构建时从数据库拉取，或 SSR 实时查询
- 格式化：< 1000 显示原数，≥ 1000 显示 `1.2k`

**加载策略：**
- 首屏显示 10 篇
- 滚动到底部触发加载更多（IntersectionObserver）
- 或一次性加载全部（文章数 < 50 时无需分页）

**动画：**
- 页面进入：StaggerContainer，卡片依次 FadeIn（0.06s 间隔）
- 标签切换：AnimatePresence，旧卡片淡出 → 新卡片淡入
- 卡片 hover：translateY + shadow 过渡

**🎨 需要的素材：**
- [ ] 分类页 Banner / 头图（可选，目前用渐变 + 光束）
- [ ] 分类专属插图或 icon（替换 emoji）

---

### 4.3 文章详情页 (`/posts/[slug]/`)

**① 阅读进度条**
- 顶部 3px 高度彩条
- 渐变色 primary-500 → primary-700
- scaleX 跟随滚动进度

**② 封面区**
- 高度 256px（移动）/ 384px（桌面）
- 图片视差滚动（translateY 80px 范围）
- 底部白色渐变消融（from-white to-transparent）
- View Transition 跨页动画支持

**③ 文章头部**
- 分类 pill + 日期 + 阅读时长（自动计算）
- 标题：3xl-4xl，LXGW WenKai 字体

**④ 正文排版（Prose 样式）**
- 最大宽度 3xl（约 768px）
- 图片自动圆角 + 阴影
- 代码块深色背景
- 链接 primary 蓝色，hover 下划线
- 标题自动锚点 + scroll-margin-top

**⑤ 桌面端浮动目录（右侧）**
- sticky 定位，top-20
- 自动提取 h2/h3 生成
- IntersectionObserver 高亮当前标题
- xl 以上屏幕显示

**⑥ 底部**
- 标签列表（#tag 胶囊）
- "← 返回XX" 导航

**🎨 需要的素材：**
- [ ] 文章封面图（每篇文章最重要的视觉素材，分类页和文章详情页使用）

---

### 4.4 全局组件

#### 导航栏 (Navbar)

- sticky 顶部，backdrop-blur 玻璃态
- 4 个导航项：首页 / 技术 / 效率 / 生活
- 活跃态：primary 色药丸背景，layoutId 共享过渡动画
- 右侧：GitHub 链接 + 主题切换（Sun/Moon 图标）
- 移动端：折叠菜单，AnimatePresence 高度动画

**🎨 需要的素材：**
- [ ] 导航栏 Logo（文字 or 图标版，替代纯文字 "openingClouds"）

#### 页脚 (Footer)

- 极简设计：著作权 + "Built with Astro" + GitHub 链接
- 玻璃态背景，向上淡入动画

#### 博客小宠物 (BlogPet)

> 🆕 **【章节更新】新增草地交互功能，详见第十一章「草地宠物交互系统」**

- 像素风绵羊精灵图（256×128px）
- 17 种动作状态（行走、挠痒、打哈欠、睡觉、吃草等）
- 追踪鼠标移动，双击切换睡眠
- 浮动 drop-shadow 阴影
- **新增**：点击页面任意位置种草，羊会自动跑去吃草

**🎨 需要的素材：**
- [x] 绵羊精灵图 ✅ 已有 (`/pets/oneko-sheep.png`)
- [x] 草地精灵图 ✅ 需新增（像素风格草丛生长/被吃掉动画）
- [ ] 可选：其他宠物皮肤（柴犬、猫咪等）

---

## 五、设计模式 & 视觉语言

| 设计模式 | 使用位置 | 效果 |
|---------|---------|------|
| **Glassmorphism（玻璃态）** | 卡片、导航栏、容器 | 半透明白底 + backdrop-blur + 细边框 |
| **Gradient Text（渐变文字）** | 品牌名 "Clouds" | bg-clip-text + primary 渐变 |
| **Cloud Sea（云海穿越）** | 首页 Hero | R3F 云海 + 相机穿行 + GodRay 光柱 |
| **Section Divider（风格线）** | 首页板块间过渡 | SVG 贝塞尔曲线（cloud/wave/tide/flow 四种变体） |
| **AnimatedNumber（数字递增）** | 数据面板 | 滚动触发的数字递增动画 |
| **Background Beams（光束）** | 分类列表页头部 | Canvas 绘制的流动光线 |
| **CardSpotlight（聚光灯）** | 所有交互卡片 | 鼠标跟踪的径向渐变光效 |
| **Stagger Animation（递进动画）** | 列表/网格进场 | 子元素按 0.06-0.08s 延迟依次出现 |
| **Scroll-driven（滚动驱动）** | 人生足迹进度条、时间线 | 滚动触发进度条绘制/节点弹出 |
| **Non-linear Layout（非线性布局）** | 高光时刻卡片、分类 tiles | translateY 错位排列，打破网格感 |
| **Parallax Layers（视差层）** | 云朵 SVG、封面图 | 不同速率移动营造深度 |
| **Paper Texture（纸质纹理）** | 全局叠加 | opacity 3% 的噪声纹理 |
| **Blur Reveal（磨砂揭示）** | 所有背景图片/封面图 | 默认 blur(8px) 磨砂态，hover 时清晰 + 放大 |

### 全局图片交互 — Blur Reveal（磨砂揭示）

所有作为背景或封面出现的图片，默认处于磨砂态，鼠标移入时放大并变清晰，营造「拨云见日」的品牌感。

```
默认态：                          Hover 态：
┌────────────────────┐           ┌────────────────────┐
│ ░░░░░░░░░░░░░░░░░░ │           │                    │
│ ░░ blur(8px)  ░░░░ │    →→→    │   清晰原图          │
│ ░░ scale(1.0) ░░░░ │  300ms    │   scale(1.05)      │
│ ░░░░░░░░░░░░░░░░░░ │  ease-out │                    │
└────────────────────┘           └────────────────────┘
```

**适用范围：**
- 瀑布流文章卡片封面
- 高光时刻卡片封面图
- 文章详情页顶部封面区
- 旅行足迹地图中的城市图片（如有）

**CSS 实现：**
```css
.blur-reveal {
  filter: blur(8px);
  transform: scale(1.0);
  transition: filter 300ms ease-out, transform 300ms ease-out;
}
.blur-reveal:hover {
  filter: blur(0);
  transform: scale(1.05);
}
```

**注意事项：**
- `overflow: hidden` 裁切放大溢出部分
- 移动端无 hover，改用 `IntersectionObserver` 进入视口时自动揭示（blur → 清晰，单次触发）
- 图片加载完成前保持 blur 态，兼作加载占位效果（skeleton → blur → 清晰）
- `will-change: filter, transform` 开启 GPU 加速，避免 blur 动画卡顿

---

## 六、后台管理系统 (`/admin/`)

> 统一管理首页各板块数据 + 文章内容，六大模块。认证方式：JWT（HS256，httpOnly cookie `oc_admin_token`）。

```
┌─────────────────────────────────────────────────────────────┐
│  启云后台                                          退出登录  │
├──────────┬──────────────────────────────────────────────────┤
│          │                                                  │
│  📊 仪表盘 │                                                  │
│          │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌────────┐│
│  📝 文章   │  │ 23 篇文章│ │ 12 个省份│ │ 35 位好友│ │ 13 节点 ││
│          │  └─────────┘ └─────────┘ └─────────┘ └────────┘│
│  🗺️ 旅行  │                                                  │
│          │  最近动态                                         │
│  🌐 社交圈 │  · 新增文章「并发编程总结」           2min ago     │
│          │  · 更新旅行：新增南京                  1h ago       │
│  🛤️ 人生线 │  · 新增好友：xxx → 同济              3h ago       │
│          │                                                  │
│  ⭐ 高光   │                                                  │
│          │                                                  │
└──────────┴──────────────────────────────────────────────────┘
```

**后台布局：**
- 左侧固定侧边栏（200px）：6 个模块导航 + 退出
- 右侧内容区：各模块页面
- 顶部面包屑导航
- 响应式：移动端侧边栏折叠为汉堡菜单

---

### 6.1 仪表盘 (`/admin/`)

首页概览，一眼看清所有数据状态。

```
┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐
│  23     │  │  12/34  │  │  35     │  │  13     │  │  6      │
│  篇文章  │  │  省份点亮 │  │  位好友  │  │  时间节点│  │  个高光  │
└─────────┘  └─────────┘  └─────────┘  └─────────┘  └─────────┘

最近操作记录（最近 20 条）
```

---

### 6.2 文章管理 (`/admin/posts`)

```
┌──────────────────────────────────────────────────────────┐
│  📝 文章管理                              [+ 新建文章]    │
├──────────────────────────────────────────────────────────┤
│  筛选：全部 | 技术 | 效率 | 生活    状态：全部 | 已发布 | 草稿│
├──────────────────────────────────────────────────────────┤
│  标题              分类    状态    阅读数   更新时间   操作  │
│  ─────────────────────────────────────────────────────── │
│  并发编程总结        技术    已发布   128    2025-02-10  ✏️🗑️│
│  Obsidian 工作流     效率    草稿     —     2025-02-08  ✏️🗑️│
│  杭州周末散步        生活    已发布    56    2025-02-05  ✏️🗑️│
│  ...                                                     │
├──────────────────────────────────────────────────────────┤
│  ← 1  2  3 →                                 共 23 篇    │
└──────────────────────────────────────────────────────────┘
```

**功能清单：**
- 文章列表：表格展示，支持分类/状态筛选，按更新时间倒序
- 新建/编辑：Markdown 编辑器 + 元数据表单（标题、slug、分类、标签、封面、描述）
- 发布/撤回：一键切换 draft 状态
- 删除：二次确认弹窗
- 阅读数统计：从 `post_views` 表读取
- 分页：20 篇/页

**数据库表：** `posts`（已有）

---

### 6.3 旅行足迹管理 (`/admin/travel`)

```
┌──────────────────────────────────────────────────────────┐
│  🗺️ 旅行足迹管理                  已点亮 12/34   [+ 新增] │
├──────────────────────────────────────────────────────────┤
│                                                          │
│  ┌── 地图预览 ──────────────────┐  ┌── 省份列表 ────────┐│
│  │                              │  │ ✅ 上海 (3 城市)    ││
│  │    [SVG 中国地图缩略图]       │  │ ✅ 浙江 (2 城市)    ││
│  │    点亮省份高亮显示            │  │ ✅ 江苏 (1 城市)    ││
│  │                              │  │ ☐ 安徽             ││
│  └──────────────────────────────┘  │ ☐ 福建             ││
│                                    │ ...                ││
│                                    └────────────────────┘│
├──────────────────────────────────────────────────────────┤
│  城市明细                                                │
│  省份      城市     时间段          标签    操作           │
│  ──────────────────────────────────────────────────────  │
│  上海      上海     2000 → 2024     生活    ✏️ 🗑️         │
│  浙江      杭州     2024-09 → 至今   求学    ✏️ 🗑️         │
│  浙江      宁波     2025-05          旅行    ✏️ 🗑️         │
│  江苏      南京     2024-10          旅行    ✏️ 🗑️         │
└──────────────────────────────────────────────────────────┘
```

**功能清单：**
- 地图预览：缩略版 SVG 地图，已录入省份高亮
- 省份列表：勾选式快速查看，点击展开该省城市
- 城市明细表格：省份、城市、时间段、标签（求学/工作/旅行/生活）
- 新增城市：选择省份 → 输入城市名 + 时间段 + 标签
- 编辑/删除城市记录
- 统计：已点亮省份数 / 总省份数

**数据库新增表：** `travel_places`

```sql
CREATE TABLE travel_places (
  id         INTEGER PRIMARY KEY AUTOINCREMENT,
  province   TEXT NOT NULL,          -- 省份名
  city       TEXT NOT NULL,          -- 城市名
  period     TEXT NOT NULL,          -- 时间段描述
  tag        TEXT NOT NULL CHECK(tag IN ('求学','工作','旅行','生活')),
  is_current INTEGER DEFAULT 0,     -- 是否当前所在
  sort_order INTEGER DEFAULT 0,
  created_at TEXT DEFAULT (datetime('now')),
  updated_at TEXT DEFAULT (datetime('now'))
);
```

**API：**
- `GET /api/admin/travel` — 列表（可按省份筛选）
- `POST /api/admin/travel` — 新增
- `PUT /api/admin/travel/[id]` — 编辑
- `DELETE /api/admin/travel/[id]` — 删除
- `GET /api/travel` — 公开接口（前端地图渲染用）

---

### 6.4 社交图谱管理 (`/admin/social`)

```
┌──────────────────────────────────────────────────────────┐
│  🌐 社交图谱管理                     共 35 人   [+ 新增]  │
├──────────────────────────────────────────────────────────┤
│  按阶段查看：全部 | 小学 | 初中 | 高中 | 同济 | 浙大 | 工作 │
├──────────────────────────────────────────────────────────┤
│                                                          │
│  ┌─ 同济大学 (12人) ──────────────────────────────────┐  │
│  │  姓名     称呼(公开)    简介        链接     操作    │  │
│  │  ─────────────────────────────────────────────────  │  │
│  │  张三     一位挚友      本科室友     🔗blog   ✏️🗑️   │  │
│  │  李四     一位同窗      学生会搭档   🔗github ✏️🗑️   │  │
│  │  王五     一位战友      志愿者伙伴   —       ✏️🗑️   │  │
│  └────────────────────────────────────────────────────┘  │
│                                                          │
│  ┌─ 浙江大学 (8人) ───────────────────────────────────┐  │
│  │  姓名     称呼(公开)    简介        链接     操作    │  │
│  │  ...                                               │  │
│  └────────────────────────────────────────────────────┘  │
└──────────────────────────────────────────────────────────┘
```

**功能清单：**
- 按人生阶段分组展示好友列表
- 新增好友：选择阶段 → 姓名 + 公开称呼 + 简介 + 头像 + 链接
- 公开称呼设置：管理员为每位好友指定访客看到的模糊称呼（"一位挚友"/"一位同窗"/"一位战友"等）
- 编辑/删除好友
- 头像上传或填写 URL
- 阶段筛选 + 人数统计

**数据库新增表：** `social_friends`

```sql
CREATE TABLE social_friends (
  id           INTEGER PRIMARY KEY AUTOINCREMENT,
  stage_id     TEXT NOT NULL,        -- 所属阶段：primary/middle/high/tongji/zju/work
  name         TEXT NOT NULL,        -- 真实姓名（仅管理员可见）
  public_label TEXT NOT NULL,        -- 访客看到的称呼
  bio          TEXT,                 -- 一句话简介（仅管理员可见）
  avatar       TEXT,                 -- 头像 URL（仅管理员可见）
  link         TEXT,                 -- 主页链接（仅管理员可见）
  platform     TEXT DEFAULT 'other', -- blog/github/twitter/weibo/other
  sort_order   INTEGER DEFAULT 0,
  created_at   TEXT DEFAULT (datetime('now')),
  updated_at   TEXT DEFAULT (datetime('now'))
);

CREATE INDEX idx_social_stage ON social_friends(stage_id);
```

**API（隐私分层）：**
- `GET /api/social-graph` — **公开接口**，只返回 `stage_id` + `public_label` + 节点数量（无姓名/链接/头像）
- `GET /api/admin/social` — 管理员完整列表
- `POST /api/admin/social` — 新增
- `PUT /api/admin/social/[id]` — 编辑
- `DELETE /api/admin/social/[id]` — 删除

---

### 6.5 人生路径管理 (`/admin/timeline`)

```
┌──────────────────────────────────────────────────────────┐
│  🛤️ 人生路径管理                    共 13 节点   [+ 新增]  │
├──────────────────────────────────────────────────────────┤
│  类型筛选：全部 | 求学 | 职业 | 家庭 | 沉淀                │
├──────────────────────────────────────────────────────────┤
│                                                          │
│  ──○── 2000-09  出生                    family  medium   │
│    │                                                     │
│  ──○── 2006-09  凉城三小·小学            learning medium  │
│    │            → 2012-07                                │
│  ──○── 2012-09  扬波中学·初中            learning medium  │
│    │            → 2016-07                                │
│  ──◇── 2018-12  暗夜与破晓              reflection  —    │
│    │            → 2019-01                                │
│  ──●── 2019-09  同济大学·本科            learning  HIGH   │
│    │            → 2023-07                                │
│  ...                                                     │
│                                                          │
│  [拖拽排序手柄 ⋮⋮]                                        │
└──────────────────────────────────────────────────────────┘

新增/编辑弹窗：
╭────────────────────────────────────────╮
│  标题 _______________                  │
│  开始日期 ____-__   结束日期 ____-__    │
│  类型 [learning ▾]  影响力 [high ▾]    │
│  描述 ___________________________      │
│  标签 ___________________________      │
│  封面 URL ________________________     │
│                                        │
│            [取消]  [保存]               │
╰────────────────────────────────────────╯
```

**功能清单：**
- 垂直时间线视图：按时间排序，直观展示人生轨迹
- 节点类型颜色区分：求学绿、职业蓝、家庭紫、沉淀灰
- `impact=high` 节点用实心大圆 `●` 标记，沉淀期用菱形 `◇`
- 拖拽排序：调整同时间段节点的显示顺序
- 新增/编辑弹窗：标题、日期范围、类型（含 reflection）、影响力、描述、标签、封面
- 删除：二次确认

**数据库表：** `timeline_nodes`（已有，需扩展 type 约束）

```sql
-- 扩展 type 枚举，增加 reflection
ALTER TABLE timeline_nodes
  DROP CONSTRAINT IF EXISTS check_type;
-- 新约束
CHECK(type IN ('career','health','learning','family','reflection'))
```

**API：** 已有 `/api/admin/timeline/*`，需扩展支持 `type=reflection`

---

### 6.6 高光时刻管理 (`/admin/highlights`)

```
┌──────────────────────────────────────────────────────────┐
│  ⭐ 高光时刻管理                     共 6 阶段   [+ 新增]  │
├──────────────────────────────────────────────────────────┤
│                                                          │
│  ┌─ 小学 ─────────────────────────────────────────────┐ │
│  │  · 三年大队长                                ✏️ 🗑️  │ │
│  │  · 800 米虹口区第二                           ✏️ 🗑️  │ │
│  │                                    [+ 添加成就]    │ │
│  └────────────────────────────────────────────────────┘ │
│                                                          │
│  ┌─ 同济大学·本科 ────────────────────────────────────┐ │
│  │  · 优秀学生、优秀学生干部                     ✏️🗑️  │ │
│  │  · 学生会主席                                ✏️🗑️  │ │
│  │  · 志愿者中队负责人                           ✏️🗑️  │ │
│  │  · 中共党员                                  ✏️🗑️  │ │
│  │  · 年级 15                                  ✏️🗑️  │ │
│  │  · 上海市优秀毕业生                           ✏️🗑️  │ │
│  │  · 优秀毕业论文                              ✏️🗑️  │ │
│  │  · 第四、五届进博会志愿者                      ✏️🗑️  │ │
│  │  · 和老婆恋爱                                ✏️🗑️  │ │
│  │                                    [+ 添加成就]    │ │
│  └────────────────────────────────────────────────────┘ │
│                                                          │
│  ┌─ 浙江大学·硕士 ────────────────────────────────────┐ │
│  │  ...                                               │
│  └────────────────────────────────────────────────────┘ │
│                                                          │
│  阶段排序：[拖拽 ⋮⋮]    成就排序：阶段内拖拽              │
└──────────────────────────────────────────────────────────┘
```

**功能清单：**
- 按人生阶段分组展示成就列表
- 两级管理：先管理阶段（小学/初中/高中/高考/同济/浙大），再管理阶段下的成就条目
- 阶段管理：新增阶段（名称 + 时间范围）、拖拽排序、删除
- 成就管理：在阶段内新增/编辑/删除/拖拽排序
- 每条成就：一句话文本，简洁即可

**数据库新增表：** `highlights`

```sql
CREATE TABLE highlight_stages (
  id         INTEGER PRIMARY KEY AUTOINCREMENT,
  label      TEXT NOT NULL,          -- 阶段名："小学"、"同济大学·本科"
  period     TEXT,                   -- 时间范围："2006-2012"
  sort_order INTEGER DEFAULT 0,
  created_at TEXT DEFAULT (datetime('now'))
);

CREATE TABLE highlight_items (
  id         INTEGER PRIMARY KEY AUTOINCREMENT,
  stage_id   INTEGER NOT NULL REFERENCES highlight_stages(id) ON DELETE CASCADE,
  content    TEXT NOT NULL,          -- 成就内容："学生会主席"
  sort_order INTEGER DEFAULT 0,
  created_at TEXT DEFAULT (datetime('now'))
);

CREATE INDEX idx_highlight_items_stage ON highlight_items(stage_id, sort_order);
```

**API：**
- `GET /api/highlights` — 公开接口（首页高光板块渲染）
- `GET /api/admin/highlights` — 管理员列表（含所有阶段和成就）
- `POST /api/admin/highlights/stages` — 新增阶段
- `PUT /api/admin/highlights/stages/[id]` — 编辑阶段
- `DELETE /api/admin/highlights/stages/[id]` — 删除阶段（级联删除成就）
- `POST /api/admin/highlights/items` — 新增成就
- `PUT /api/admin/highlights/items/[id]` — 编辑成就
- `DELETE /api/admin/highlights/items/[id]` — 删除成就
- `PATCH /api/admin/highlights/reorder` — 拖拽排序（阶段或成就）

---

## 七、动画清单

### 首页动画

| 动画 | 实现 | 触发时机 | 所属板块 |
|------|------|---------|---------|
| CloudSea（云海穿越） | R3F useFrame | 始终播放（相机前推 + 云回收） | Section 1 Hero |
| GodRay（光柱脉动） | R3F useFrame | 始终播放 | Section 1 Hero |
| SloganSlide（标语滑动） | Motion AnimatePresence | 4s 间隔垂直切换 | Section 1 Hero |
| ProgressDraw（进度绘制） | Motion scaleX | ScrollReveal 触发，从左到右绘制 | Section 2 人生足迹 |
| ReflectionPulse（沉淀菱形脉动） | Motion | 菱形节点微弱呼吸 | Section 2 人生足迹 |
| ProvinceSpread（省份扩散点亮） | StaggerItem | ScrollReveal 触发，从上海向外蔓延 | Section 4 旅行足迹 |
| MapHoverFloat（地图浮窗） | Motion | 鼠标悬停省份 | Section 4 旅行足迹 |
| GraphBurst（图谱节点弹出） | D3 force + Motion | 大节点出现 → 小节点从中心 burst 散开 | Section 5 社交图谱 |
| GraphIdle（图谱呼吸浮动） | D3 force / sin 波 | 始终播放，节点微微漂移 | Section 5 社交图谱 |
| AnimatedNumber（数字递增） | Motion / RAF | 进入视口时递增 | Section 6 数据面板 |
| **GrassGrow（草地生长）** 🆕 | CSS keyframes | 点击页面触发 | 全局草地交互 |
| **SheepEatGrass（羊吃草）** 🆕 | 精灵图切换 | 羊到达草位置触发 | 全局草地交互 |

### 全局动画

| 动画 | 实现 | 触发时机 | 使用位置 |
|------|------|---------|---------|
| FadeIn（淡入） | Motion | 进入视口 | 各板块通用 |
| StaggerContainer（递进入场） | Motion | 容器进入视口 | 列表/网格/卡片组 |
| ScrollReveal（滚动揭示） | Motion useScroll | 持续滚动 | 各板块通用 |
| ParallaxSection（视差段落） | Motion useTransform | 持续滚动 | 云朵 SVG、封面图 |
| BlurReveal（磨砂揭示） | CSS transition | hover（桌面）/ 进入视口（移动端） | 所有背景图/封面图 |
| NavPill（导航药丸） | Motion layoutId | 导航切换 | Navbar |
| TagUnderline（标签下划线滑动） | Motion layoutId | 标签切换 | 分类列表页筛选栏 |
| ViewTransition（跨页过渡） | Astro VT API | 页面跳转 | 全局 |
| BlogPet（宠物追踪） | setInterval 16ms | 鼠标移动 | 全局 |
| **PetEatState（宠物吃草状态）** 🆕 | 状态机切换 | 羊开始吃草 | 全局草地交互 |

### 文章详情页动画

| 动画 | 实现 | 触发时机 | 使用位置 |
|------|------|---------|---------|
| ReadingProgress（阅读进度条） | scaleX + scroll | 文章页滚动 | 顶部进度条 |
| CoverParallax（封面视差） | Vanilla scroll | 文章页滚动 | 封面区 |

### 分类列表页动画

| 动画 | 实现 | 触发时机 | 使用位置 |
|------|------|---------|---------|
| BackgroundBeams（光束） | Canvas RAF | 始终播放 | 分类页头部 |
| MasonryStagger（瀑布流入场） | StaggerContainer | 页面加载 / 标签切换 | 文章卡片列表 |
| TagSwitch（标签切换过渡） | AnimatePresence | 切换标签 | 卡片淡出 → 淡入 |

---

## 八、素材需求总览

> 根据第一至七章所有板块重新梳理，按类别分为：品牌标识、图片、视频、图标、数据/矢量。

---

### 🏷️ 品牌标识系统（Logo）

品牌名 **openingClouds**（启云），核心意象：**云朵 + 绵羊 + 天空**。

**主徽标设计 — 云中绵羊：**

```
     ╭──────╮
   ╭─╯  ╭╮  ╰──╮        openingClouds
  ─╯    ╰╯🐑   ╰─       Tech · Efficiency · Life

   ← 图标：云+羊 →       ← 文字区 →
```

- 图标：一朵云的轮廓，内部嵌入一只简笔绵羊剪影
- 云朵 = 3 段不对称圆弧，左低右高，带手绘感
- 绵羊 = 椭圆身体 + 2-3 条卷毛弧线 + 4 短腿 + 圆头三角耳
- 组合：绵羊是云的一部分（镂空/反色融入），暗示"在云端漫步的羊"
- 文字："opening" 400 字重 + "Clouds" 600 字重 azure 渐变
- 整体线宽统一 2px，克制线性

**四个版本：**

| 版本 | 用途 | 规格 | 配色 |
|------|------|------|------|
| **全版（横排）** | 导航栏、页脚、OG 图 | SVG，高度 40px | azure-500 `#4F6AE5` |
| **图标版** | Favicon、App 图标 | SVG + 192×192 PNG | 白底蓝图标 / 蓝底白图标 |
| **浅色版** | 深色背景使用 | SVG | 白色 `#FFFFFF` |
| **深色版** | 浅色背景使用 | SVG | ink-900 `#1A1D2E` |

**AI 生成 Prompt：**

```
Minimalist line-art logo. A single cloud outline with a tiny sheep silhouette
embedded inside (not on top). Cloud: 3 smooth asymmetric arcs. Sheep: oval body,
2-3 curly wool arcs, 4 short legs, small round head with triangle ears.
Uniform 2px line weight. Single color #4F6AE5 on transparent background.
Clean, geometric but warm. No gradients, no shadows. SVG vector output.
```

---

### 🖼️ 图片素材

| # | 素材 | 数量 | 规格 | 来源板块 | 说明 | 优先级 |
|---|------|------|------|---------|------|-------|
| 1 | **文章封面图** | ~50+ 张 | 1200×800px, WebP | 4.2 分类列表页 + 4.3 文章详情页 | 瀑布流卡片 + 详情页封面，默认 blur 态 hover 清晰。按分类调色：技术 sage、效率 amber、生活 mauve | 🔴 高 |
| 2 | **Hero 背景 fallback** | 1 张 | 1920×1080px, WebP | Section 1 Hero | R3F 云海不可用时的静态替代，黄昏色调云海全景 | 🔴 高 |
| 3 | **OG 社交分享图** | 1 张 | 1200×630px, PNG | 全局 meta | 品牌 Logo + 标语 + 云海背景 | 🟡 中 |
| 4 | **分类默认封面** | 3 张 | 1200×800px, WebP | 4.2 分类列表页 | 无封面文章的图片 fallback（已有 CoverFallback 组件可替代） | 🟡 中 |
| 5 | **404 页面插图** | 1 张 | 800×600px, WebP | 404 页面 | 迷路绵羊主题插画 | 🟢 低 |

### 🎬 视频素材

| # | 素材 | 规格 | 来源板块 | 说明 | 优先级 |
|---|------|------|---------|------|-------|
| 1 | **Hero 背景视频** | 1920×1080, WebM | Section 1 Hero | 云海延时摄影，R3F 不可用时的高级 fallback（可选） | 🟢 低 |

### 🎨 图标素材

| # | 素材 | 数量 | 来源板块 | 说明 | 优先级 |
|---|------|------|---------|------|-------|
| 1 | **分类图标** | 3 个 SVG | 4.2 分类列表页头部 | 技术/效率/生活，替换 💻📚📷，线性风格，跟随分类主色 | 🟡 中 |
| 2 | **数据面板图标** | 4 个 SVG | Section 6 数据面板 | 文章数/字数/标签数/天数，替换 ✍️📝🏷️📅 | 🟡 中 |
| 3 | **时间线类型图标** | 5 个 SVG | Section 2 人生足迹 | 职业/求学/健康/家庭/沉淀，替换 💼📚💪🏠🌧️ | 🟡 中 |
| 4 | **联系方式图标** | 2 个 SVG | Section 7 联系方式 | 邮箱 + GitHub | 🟢 低 |
| 5 | **宠物皮肤** | 2-3 套 | 全局 BlogPet | 256×128 精灵图，像素风 | 🟢 低 |
| 6 | **草地精灵图** 🆕 | 1 套 | 全局草地交互 | 32×32/帧，草生长、草被吃掉的像素动画 | 🟡 中 |

### 🗺️ 数据/矢量素材

| # | 素材 | 数量 | 来源板块 | 说明 | 优先级 |
|---|------|------|---------|------|-------|
| 1 | **SVG 中国地图** | 1 份 | Section 4 旅行足迹 | 省级轮廓，每省独立 `<path>` 可填色。推荐来源：ECharts map / DataV.GeoAtlas | 🔴 高 |
| 2 | **风格线 SVG** | 6 条 | 首页板块过渡 | cloud / wave / tide / ridge / dust / flow 六种变体 | 🟡 中 |

---

### 📊 素材统计

| 类别 | 🔴 高 | 🟡 中 | 🟢 低 | 合计 |
|------|-------|-------|-------|------|
| 品牌标识 | 4 版 Logo | — | — | 4 |
| 图片 | 52+ | 4 | 1 | 57+ |
| 视频 | — | — | 1 | 1 |
| 图标 | — | 13 | 4-5 | 17+ |
| 数据/矢量 | 1 | 6 | — | 7 |

---

## 九、风格指引（AI 生成 Prompt）

> 所有 Prompt 均为英文（AI 图像生成工具对英文理解更好），附中文说明。
> 全局色系：靛蓝 `#4F6AE5`、青灰 `#6B917B`、琥珀 `#B8945E`、雾紫 `#9684A8`、墨灰 `#1A1D2E`。

---

### 1. 品牌 Logo（4 版）

```
Minimalist line-art logo for a personal blog called "openingClouds".
A single cloud outline with a tiny sheep silhouette embedded inside
(not on top — the sheep IS part of the cloud). Cloud shape: 3 smooth
asymmetric arcs, left-low right-high, hand-drawn feel. Sheep: oval body
with 2-3 curly wool arcs along the top, 4 short straight legs, small
round head with triangle ears. Uniform 2px stroke weight throughout.
Single flat color #4F6AE5 on transparent background.
Style: clean, geometric but warm, like a rubber stamp. Absolutely no
gradients, no shadows, no fills. Pure line art. Vector SVG output.
```

**变体指令追加：**
- 图标版：`Same design, but crop to just the cloud-sheep icon without text. Square 1:1 ratio.`
- 浅色版：`Same design, change color to pure white #FFFFFF on transparent.`
- 深色版：`Same design, change color to dark navy #1A1D2E on transparent.`

---

### 2. 文章封面图

**通用基底 Prompt（所有封面图前置）：**

```
Digital illustration, 3:2 landscape ratio (1200x800px). Low-saturation
muted tones. Clean composition with subject centered slightly above middle,
generous negative space at bottom edge for gradient overlay. Soft ambient
lighting, no harsh shadows. Subtle paper grain texture overlay at 3% opacity.
Style: modern flat illustration with gentle depth, inspired by Ghibli
background art meets minimal editorial design. --no text, watermark, logo
```

**技术文章封面（sage 青灰调）：**

```
[通用基底] +
Color palette dominated by muted sage green #6B917B and steel blue #4F6AE5.
Subject matter options (pick one per article):
- Floating code editor windows in a misty digital landscape
- Abstract circuit board patterns dissolving into clouds
- Neural network visualization with glowing nodes, cool-toned
- Server rack room with volumetric fog and blue ambient light
- Data stream flowing through geometric tunnels
Overall mood: calm, professional, cerebral. Cool temperature.
```

**效率文章封面（amber 琥珀调）：**

```
[通用基底] +
Color palette dominated by warm amber #B8945E and burnished gold.
Subject matter options (pick one per article):
- Hourglass with golden sand particles floating upward
- Interlocking brass gears in warm afternoon light
- Calendar grid with one date glowing warmly
- Knowledge graph with interconnected nodes, warm-toned
- Notebook and pen on wooden desk, golden hour lighting
Overall mood: warm, productive, contemplative. Golden hour temperature.
```

**生活文章封面（mauve 雾紫调）：**

```
[通用基底] +
Color palette dominated by dusty mauve #9684A8 and soft lavender.
Subject matter options (pick one per article):
- Window view of a quiet city street at dusk
- Steaming cup of tea with scattered dried flowers
- Rainy day scene through frosted glass
- Green plants on a windowsill, soft purple twilight outside
- Walking path through a misty park, lanterns glowing
Overall mood: gentle, personal, dreamy. Cool-warm twilight temperature.
```

---

### 3. Hero 背景 fallback（静态图）

```
Panoramic cloudscape at golden hour, seen from above the cloud layer.
Camera positioned as if flying through clouds. Dramatic god rays piercing
through gaps in cumulus clouds from upper right. Color palette: deep navy
#0B0E18 in shadows transitioning to warm amber #B8945E and soft azure
#4F6AE5 where light hits the cloud edges. Volumetric fog, ethereal depth.
Ultra-wide 16:9 ratio (1920x1080px). Photorealistic with painterly edges.
Mood: majestic, serene, "parting the clouds to see the sun" (拨云见日).
--no airplane, birds, ground, buildings, text
```

---

### 4. Hero 背景视频（云海延时）

```
Slow-motion timelapse of clouds viewed from above, flying forward through
a sea of cumulus clouds at golden hour. Camera moves steadily forward at
walking pace. God rays break through cloud gaps. Color grading: deep navy
shadows (#0B0E18) with warm amber highlights (#B8945E). Volumetric fog
drifts past camera. 10-15 second seamless loop. 1920x1080, 30fps.
Mood: meditative, grand, endless journey through clouds.
--no ground, buildings, aircraft visible
```

---

### 5. OG 社交分享图

```
Blog social sharing card (1200x630px). Background: aerial cloudscape
at dusk with subtle god rays breaking through, blurred and darkened to
60% opacity. Foreground centered: the openingClouds logo (cloud with
embedded sheep, white line art) at 120px height. Below logo:
"openingClouds" in clean sans-serif, white. Below that in smaller text:
"Tech · Efficiency · Life" in azure #4F6AE5. Generous padding all around.
Overall: professional, clean, recognizable at small social media thumbnail size.
```

---

### 6. 分类默认封面（3 张）

```
技术 (sage):
Abstract digital landscape, floating geometric shapes and code snippets
dissolving into mist. Dominated by sage green #6B917B and steel blue.
Minimal, editorial feel. 1200x800px. --no text

效率 (amber):
Warm still life of analog tools — brass compass, leather journal, ink pen —
arranged on aged wooden surface. Golden hour lighting. Dominated by
amber #B8945E. 1200x800px. --no text

生活 (mauve):
Dreamy dusk scene — a quiet balcony with string lights, a cup of tea,
distant city skyline blurred in soft lavender haze. Dominated by
mauve #9684A8. 1200x800px. --no text
```

---

### 7. 404 页面插图

```
Cute minimalist illustration of a small fluffy sheep standing alone
in a vast misty cloudscape, looking slightly confused. The sheep has
curly wool (matching the blog logo style), standing on a single small
cloud island. A wooden sign next to it reads "404". Surrounding:
empty fog, a few distant cloud silhouettes. Color palette: ink-gray
#1A1D2E lines on soft white/light blue background. Style: clean line
art with minimal watercolor wash fills, gentle and whimsical.
800x600px. --no other animals, no buildings
```

---

### 8. SVG 图标系列

**通用风格指令（所有图标共用）：**

```
Minimal line icon, uniform 1.5px stroke, rounded line caps and joins.
Single color, no fill. 24x24 viewBox. Clean geometric style matching
the openingClouds brand. Output: SVG path data.
```

**分类图标 ×3：**

```
技术: Terminal window icon with "> _" cursor prompt. Color: #6B917B
效率: Open book with a small lightbulb above it. Color: #B8945E
生活: Camera shutter icon, simplified to circle + aperture blades. Color: #9684A8
```

**数据面板图标 ×4：**

```
文章数: Stacked document pages with a pencil. Color: #4F6AE5
总字数: Text lines icon (3 horizontal lines, decreasing width). Color: #4F6AE5
标签数: Price tag / label icon with a small circle hole. Color: #4F6AE5
天数: Calendar icon with a clock overlay in corner. Color: #4F6AE5
```

**时间线类型图标 ×5：**

```
职业 career: Briefcase icon, simple rectangle with handle. Color: #4F6AE5
求学 learning: Graduation cap (mortarboard) icon. Color: #6B917B
健康 health: Dumbbell icon, horizontal bar with circles. Color: #B8945E
家庭 family: Simple house outline with heart inside. Color: #9684A8
沉淀 reflection: Cloud with rain drops (2-3 drops). Color: #6B7280
```

**联系方式图标 ×2：**

```
邮箱: Envelope icon, rectangle with V-shaped flap. Color: #4F6AE5
GitHub: GitHub octocat silhouette (standard). Color: #4F6AE5
```

---

### 9. 宠物精灵图皮肤

```
Pixel art sprite sheet, 256x128px total, 32x32px per frame. 8 columns × 4 rows.
Character: [柴犬/猫咪/兔子] in cute chibi pixel style, 4-color palette maximum.
Frames should cover: idle, walk-right (4 frames), walk-left (4 frames),
scratch, yawn, sleep (2 frames), sit, alert. Each frame clearly
distinguishable at small size. Transparent background. Style: retro
pixel art, inspired by oneko/neko screensaver cats from the 90s.
```

### 10. 草地精灵图 🆕

```
Pixel art sprite sheet, 128×64px total, 32×32px per frame. 4 columns × 2 rows.
Subject: grass growing animation. Frame 1-2: small sprout emerging from ground.
Frame 3-4: full grass tuft (3-5 blades, varied heights). Color: sage green #6B917B.
Transparent background. Style: cute pixel art matching the sheep sprite.
Additional eating animation: grass tuft shrinking/disappearing (2 frames).
```

---

## 十一、草地宠物交互系统 🆕

### 11.1 功能概述

在现有博客小宠物系统（oneko-sheep 绵羊）基础上，新增**草地种植与互动系统**，为博客页面增加趣味性和温馨感，强化"天空、云朵、牧场、绵羊"的品牌意象。

---

### 11.2 核心交互流程

```
用户点击页面任意位置
        ↓
   在点击处播放草生长动画
        ↓
  绵羊被吸引，转向该位置
        ↓
  绵羊走到草的位置
        ↓
   绵羊开始吃草（精灵图切换）
        ↓
  草被吃完，绵羊恢复自由移动
```

---

### 11.3 详细功能规格

#### ① 种草触发

**触发条件：**
- 用户点击页面任意位置（非链接、非按钮、非可交互元素）
- 使用 `window.addEventListener('click', ...)` 全局监听
- 需要判断点击目标：`event.target.closest('a, button, input, [role="button"]')` 则跳过

**草生长动画：**
- **视觉**：像素风格草丛，从点击处从小到大"破土而出"
- **位置**：精确跟随点击的 `clientX`, `clientY` 坐标
- **尺寸**：初始 0px → 最终 32×32px，动画时长 300ms
- **精灵图帧序列**：
  - Frame 0-1: 小嫩芽刚冒头（2px 高度）
  - Frame 2-3: 草长到一半高度
  - Frame 4-5: 完整草丛（3-5 根草，错落高度）
- **CSS 动画**：
  ```css
  @keyframes grass-grow {
    0% { transform: scale(0) translateY(16px); opacity: 0; }
    100% { transform: scale(1) translateY(0); opacity: 1; }
  }
  .grass-item {
    position: fixed;
    z-index: 100;
    pointer-events: none;
    animation: grass-grow 0.3s ease-out forwards;
  }
  ```

---

#### ② 绵羊行为状态机

**状态列表（扩展现有的 17 种状态）：**

| 状态 | 触发条件 | 精灵图帧 | 行为说明 |
|------|---------|---------|---------|
| `idle` | 默认状态 | idle 帧 | 跟随鼠标移动 |
| `walking_to_grass` | 检测到草 | walk-left/right 帧 | 转向草位置，直线移动 |
| `eating` | 到达草位置 | eat 帧（新增） | 头部向下吃草动画 |
| `finished_eating` | 吃完草 | idle 帧 | 恢复自由移动 |

**新增精灵图帧（吃草动画）：**
- `eat_1`: 羊低头，嘴巴张一点
- `eat_2`: 羊嘴巴闭合，咀嚼动作
- `eat_3`: 重复 eat_1/eat_2 循环 3-5 次
- **位置**：精灵图第 3 行，帧 5-8（32×32px，256×128px 精灵图的空位）

---

#### ③ 绵羊路径算法

**目标选择策略：**

1. **优先级**：按草种植时间排序（FIFO，先种的先吃）
2. **距离优化**：如果同时有多棵草，选择最近的一棵
3. **最大距离限制**：如果草距离羊超过 800px，羊忽略（避免跨屏跑）

**移动逻辑：**
```javascript
// 伪代码
function updateSheepPosition(sheep, grassList) {
  if (sheep.state === 'idle' && grassList.length > 0) {
    // 找到最近的草
    const nearestGrass = findNearestGrass(sheep.position, grassList);
    if (nearestGrass && distance(sheep.position, nearestGrass.position) < 800) {
      sheep.state = 'walking_to_grass';
      sheep.target = nearestGrass;
      sheep.direction = calculateDirection(sheep.position, nearestGrass.position);
    }
  }

  if (sheep.state === 'walking_to_grass') {
    // 向目标移动，速度 2-3px/frame
    const speed = 2.5;
    const dx = sheep.target.position.x - sheep.position.x;
    const dy = sheep.target.position.y - sheep.position.y;
    const distance = Math.sqrt(dx * dx + dy * dy);

    if (distance < speed) {
      // 到达
      sheep.position = sheep.target.position;
      sheep.state = 'eating';
      startEatingAnimation(sheep);
    } else {
      // 继续移动
      sheep.position.x += (dx / distance) * speed;
      sheep.position.y += (dy / distance) * speed;
    }
  }
}
```

---

#### ④ 吃草动画

**视觉反馈：**
- 羊的精灵图切换到 `eat_1` / `eat_2` 循环
- 持续时长：2-3 秒（咀嚼 6-9 次）
- 草的透明度逐渐降低（1 → 0），模拟被吃掉
- 动画结束后：草元素从 DOM 移除，羊恢复 `idle` 状态

**草消失动画：**
```css
@keyframes grass-eaten {
  0% { opacity: 1; transform: scale(1); }
  100% { opacity: 0; transform: scale(0.5) translateY(-8px); }
}
.grass-item.eating {
  animation: grass-eaten 0.5s ease-in forwards;
}
```

---

#### ⑤ 多棵草管理

**数据结构：**
```typescript
interface GrassItem {
  id: string;              // 唯一 ID
  x: number;               // 屏幕 X 坐标
  y: number;               // 屏幕 Y 坐标
  plantedAt: number;       // 种植时间戳
  isBeingEaten: boolean;   // 是否正在被吃
  element: HTMLElement;    // DOM 元素引用
}

// 全局草列表
const grassList: GrassItem[] = [];
```

**列表维护：**
- 添加草：点击时 `grassList.push(newGrass)`
- 删除草：吃完后 `grassList = grassList.filter(g => g.id !== eatenGrass.id)`
- 最大数量限制：同时最多存在 10 棵草（超出则最早的自动枯萎消失）

---

### 11.4 技术实现方案

#### 前端组件结构

```
src/
├── components/
│   ├── BlogPet.astro           // 绵羊主组件（扩展）
│   └── GrassInteraction.astro  // 草地交互逻辑（新增）
├── assets/
│   └── pets/
│       ├── oneko-sheep.png     // 绵羊精灵图（已有）
│       └── grass-sprite.png    // 草精灵图（新增）
└── styles/
    └── grass-animation.css     // 草动画样式（新增）
```

#### 组件逻辑伪代码

```typescript
// GrassInteraction.astro
<script setup>
  import { onMounted, onUnmounted } from 'astro';

  const grassList = ref([]);
  let grassIdCounter = 0;

  // 全局点击监听
  const handleClick = (e: MouseEvent) => {
    // 跳过可交互元素
    if (e.target.closest('a, button, input')) return;

    createGrass(e.clientX, e.clientY);
  };

  const createGrass = (x: number, y: number) => {
    const id = `grass-${grassIdCounter++}`;
    const grass = {
      id,
      x,
      y,
      plantedAt: Date.now(),
      isBeingEaten: false,
    };

    grassList.value.push(grass);

    // 创建 DOM 元素
    const el = document.createElement('div');
    el.className = 'grass-item';
    el.style.left = `${x - 16}px`; // 居中
    el.style.top = `${y}px`;
    el.id = id;
    document.body.appendChild(el);
    grass.element = el;

    // 最大数量限制
    if (grassList.value.length > 10) {
      const oldest = grassList.value.shift();
      oldest.element.remove();
    }
  };

  const removeGrass = (id: string) => {
    const index = grassList.value.findIndex(g => g.id === id);
    if (index !== -1) {
      const grass = grassList.value[index];
      grass.element.remove();
      grassList.value.splice(index, 1);
    }
  };

  // 暴露给 BlogPet 组件
  window.grassManager = { grassList, removeGrass };

  onMounted(() => {
    window.addEventListener('click', handleClick);
  });

  onUnmounted(() => {
    window.removeEventListener('click', handleClick);
  });
</script>
```

```typescript
// BlogPet.astro（扩展）
<script setup>
  // ... 原有代码 ...

  // 新增状态
  let petState = 'idle'; // idle | walking_to_grass | eating
  let currentGrassTarget = null;

  // 扩展原有的 update() 函数
  const update = () => {
    if (petState === 'idle') {
      // 检查是否有草
      const grassList = window.grassManager?.grassList || [];
      if (grassList.length > 0) {
        const nearest = findNearestGrass(grassList);
        if (nearest) {
          petState = 'walking_to_grass';
          currentGrassTarget = nearest;
          nearest.isBeingEaten = true;
        }
      }
      // 原有的跟随鼠标逻辑
      followMouse();
    } else if (petState === 'walking_to_grass') {
      walkToGrass(currentGrassTarget);
    } else if (petState === 'eating') {
      // 吃草动画由精灵图控制，无需额外逻辑
    }

    // 更新精灵图帧
    updateSpriteFrame();
    requestAnimationFrame(update);
  };

  const walkToGrass = (grass: GrassItem) => {
    const dx = grass.x - petPosition.x;
    const dy = grass.y - petPosition.y;
    const dist = Math.sqrt(dx * dx + dy * dy);

    if (dist < 4) {
      // 到达
      petState = 'eating';
      startEatingAnimation(grass);
    } else {
      // 移动
      const speed = 2.5;
      petPosition.x += (dx / dist) * speed;
      petPosition.y += (dy / dist) * speed;
      // 设置方向
      direction = dx > 0 ? 'right' : 'left';
    }
  };

  const startEatingAnimation = (grass: GrassItem) => {
    // 切换到 eat 精灵图帧
    currentFrameSet = 'eat';

    // 2.5 秒后完成
    setTimeout(() => {
      // 移除草
      window.grassManager.removeGrass(grass.id);
      // 恢复空闲
      petState = 'idle';
      currentFrameSet = 'idle';
      currentGrassTarget = null;
    }, 2500);
  };
</script>
```

---

### 11.5 性能优化

- **DOM 节点限制**：同时最多 10 棵草，超出自动删除
- **requestAnimationFrame**：所有动画使用 RAF 统一调度
- **CSS transform**：使用 `transform` 替代 `top/left` 触发 GPU 加速
- **事件节流**：点击事件 200ms 内只触发一次
- **内存清理**：草被吃掉后立即从 `grassList` 和 DOM 移除

---

### 11.6 适配考虑

- **移动端**：缩小草的尺寸为 24×24px，羊移动速度降低至 2px/frame
- **暗黑模式**：草的颜色在暗色模式下使用 sage-400（更亮）
- **性能模式**：如果用户设备性能检测为低端，禁用草地交互

---

### 11.7 用户反馈

- **初次提示**：首次访问时，toast 提示"点击页面可以种草哦！🐑"
- **趣味文案**：羊吃草时，随机显示气泡：
  - "真香~"
  - "好吃！"
  - "谢谢款待~"
  - "再来一棵！"
- **统计（可选）**：在后台仪表盘显示"累计种植草 XX 棵，羊吃掉 XX 棵"

---

### 11.8 开发任务清单

| 任务 | 优先级 | 说明 |
|------|-------|------|
| 草精灵图设计绘制 | 🔴 高 | 32×32px，生长 + 吃掉动画，6-8 帧 |
| GrassInteraction 组件开发 | 🔴 高 | 点击监听、草列表管理、DOM 创建/删除 |
| BlogPet 状态机扩展 | 🔴 高 | 新增 walking_to_grass、eating 状态 |
| 路径算法实现 | 🔴 高 | 最近草查找、距离判断、移动逻辑 |
| 吃草动画整合 | 🟡 中 | 精灵图切换、草消失动画 |
| 性能优化 | 🟡 中 | DOM 限制、RAF 调度、事件节流 |
| 移动端适配 | 🟡 中 | 尺寸调整、速度调整 |
| 趣味文案气泡 | 🟢 低 | 随机吃草文案 |
| 后台统计 | 🟢 低 | 种草/吃草数量统计 |

---

## 十二、Obsidian 单向同步系统 🆕

### 12.1 功能概述

实现 Obsidian 笔记仓库与博客数据库之间的**单向数据同步**：用户在 Obsidian 笔记中添加 `publish: true` frontmatter 属性后，通过脚本将笔记推送到博客系统的数据库中，自动生成博客文章。

---

### 12.2 数据源配置

**Obsidian 仓库路径：**
```
/Users/openingcloud/Documents/GardenOfOpeningClouds
```

**仓库结构：**
```
GardenOfOpeningClouds/
├── 3-Knowledge/
│   ├── T_工业技术/
│   │   ├── TP_自动化技术/
│   │   │   └── 自动化控制基础.md
│   │   └── TP_计算机技术/
│   │       ├── 数据结构与算法.md
│   │       └── 操作系统原理.md
│   └── O_数理科学/
│       └── 高等数学笔记.md
├── 5-Economics/
│   └── 经济学原理.md
└── daily/
    └── 2025-01-15-日记.md
```

**统计：**
- 总笔记数：690+ 篇
- 分类方式：按中图法分类（3-Knowledge、5-Economics 等）
- 文件格式：Markdown (`.md`)

---

### 12.3 同步规则设计

#### ① Frontmatter 识别

**发布标识：**
```yaml
---
title: 数据结构与算法
publish: true    ← 必填：true 发布，false 或不填则不同步
date: 2025-01-15
category: tech   ← 可选：tech / learning / life（默认按文件夹路径映射）
tags:
  - 算法
  - 数据结构
cover: https://example.com/cover.png   ← 可选：封面图 URL
description: 本篇笔记总结了核心数据结构...   ← 可选：文章摘要
---
```

**必填字段：**
- `publish: true` — 标识该笔记需要同步到博客

**可选字段：**
- `title` — 标题（默认取文件名，去掉 .md 后缀）
- `date` — 发布日期（默认取文件创建时间或 git commit 时间）
- `category` — 博客分类（tech/learning/life，默认按路径映射）
- `tags` — 标签数组（默认从 `#标签` 提取）
- `cover` — 封面图 URL（默认使用分类默认封面或 AI 生成）
- `description` — 文章摘要（默认取正文前 150 字）

---

#### ② 分类映射规则

**Obsidian 中图法分类 → 博客分类映射：**

| Obsidian 路径 | 博客分类 | 映射逻辑 |
|--------------|---------|---------|
| `3-Knowledge/T_工业技术/TP_计算机技术/` | `tech` | 技术类文章 |
| `3-Knowledge/T_工业技术/TP_自动化技术/` | `tech` | 技术类文章 |
| `3-Knowledge/T_工业技术/` | `tech` | 工业技术大类 |
| `3-Knowledge/*` | `learning` | 知识大类，默认学习类 |
| `5-Economics/*` | `learning` | 经济学 |
| `daily/` | `life` | 日记 |
| `travel/` | `life` | 旅行记录 |
| 其他 | `learning` | 默认归类 |

**配置文件示例** (`sync-config.json`)：
```json
{
  "categoryMapping": {
    "3-Knowledge/T_工业技术": "tech",
    "3-Knowledge": "learning",
    "5-Economics": "learning",
    "daily": "life",
    "travel": "life",
    "default": "learning"
  }
}
```

---

#### ③ Slug 生成规则

**规则：**
1. 使用 `title` 字段或文件名作为基础
2. 转为小写
3. 移除特殊字符（保留中文、英文、数字、连字符）
4. 替换空格为连字符
5. 避免重复：如果 slug 已存在，追加 `-2`、`-3` 等后缀

**示例：**
```
文件名: 数据结构与算法.md
Title: 数据结构与算法
Slug: 数据结构与算法

文件名: 2025-01-15-杭州周末散步.md
Title: 杭州周末散步
Slug: 杭州周末散步

文件名: Git 工作流总结.md
Title: Git 工作流总结
Slug: git-workflow-summary

重复处理:
Git 工作流总结.md → git-workflow-summary
Git 工作流总结.md (第2次) → git-workflow-summary-2
```

---

#### ④ 标签提取规则

**优先级：**
1. Frontmatter `tags` 字段（显式声明）
2. 文档内 `#标签` 格式（从正文提取）

**提取逻辑：**
```typescript
function extractTags(content: string, frontmatterTags?: string[]): string[] {
  // 1. 如果 frontmatter 有 tags，优先使用
  if (frontmatterTags && frontmatterTags.length > 0) {
    return frontmatterTags;
  }

  // 2. 从正文提取 #标签
  const tagRegex = /#([^\s#]+)/g;
  const matches = content.matchAll(tagRegex);
  const tags = [...matches].map(m => m[1]);

  // 3. 去重 + 过滤（排除 #标题、#列表等）
  return [...new Set(tags)]
    .filter(t => !t.match(/^[一二三四五六七八九十]+、/)) // 排除 #一、#二...
    .slice(0, 10); // 最多 10 个标签
}
```

---

#### ⑤ 封面图处理

**优先级：**
1. Frontmatter `cover` 字段（显式 URL）
2. 文档内 `![[图片]]` Obsidian 内部引用（上传到图床后替换）
3. 分类默认封面（sage/amber/mauve 三套）
4. AI 生成封面（调用 Stable Diffusion API，可选）

**Obsidian 内部图片处理：**
```markdown
---
cover: [[assets/cover.png]]   ← Obsidian 内部引用
---

正文中的图片：
![数据结构示意图](assets/algorithm-diagram.png)
```

**转换逻辑：**
1. 检测到 `[[xxx]]` 格式，读取 Obsidian 仓库中的图片文件
2. 上传到图床（阿里云 OSS / 七牛云 / Cloudflare Images）
3. 替换为外链 URL

---

### 12.4 同步脚本设计

#### 技术栈
- 语言：TypeScript / Node.js
- Markdown 解析：`gray-matter`（frontmatter）、`marked`（转 HTML）
- 文件遍历：`glob`
- Git 时间获取：`simple-git`

#### 目录结构
```
scripts/
├── obsidian-sync/
│   ├── index.ts              // 主脚本入口
│   ├── config.ts            // 配置加载
│   ├── parser.ts            // Markdown 解析
│   ├── mapper.ts            // 分类/标签映射
│   ├── uploader.ts          // 图片上传（图床）
│   ├── api-client.ts        // 博客 API 调用
│   └── types.ts             // 类型定义
├── sync-config.json          // 同步配置
└── .env.example             // 环境变量示例
```

#### 核心代码框架

```typescript
// index.ts
import { readdirSync } from 'fs';
import matter from 'gray-matter';
import { syncToBlog } from './api-client';
import { parseNote } from './parser';
import { mapCategory } from './mapper';
import config from './sync-config';

async function main() {
  console.log('🚀 开始同步 Obsidian 笔记...');

  // 1. 遍历 Obsidian 仓库
  const allNotes = globSync('**/*.md', {
    cwd: config.obsidianPath,
    ignore: ['.obsidian/**', 'daily/**', 'template/**'],
  });

  console.log(`📚 找到 ${allNotes.length} 篇笔记`);

  let syncedCount = 0;
  let skippedCount = 0;

  for (const notePath of allNotes) {
    const fullPath = path.join(config.obsidianPath, notePath);

    // 2. 解析 Markdown + Frontmatter
    const { data: frontmatter, content } = matter(fullPath);

    // 3. 检查是否发布
    if (!frontmatter.publish) {
      skippedCount++;
      continue;
    }

    // 4. 提取元数据
    const noteData = parseNote(fullPath, frontmatter, content);

    // 5. 分类映射
    noteData.category = mapCategory(notePath, frontmatter.category);

    // 6. 标签提取
    noteData.tags = extractTags(content, frontmatter.tags);

    // 7. 封面图处理
    noteData.cover = await processCover(frontmatter.cover, notePath);

    // 8. 同步到博客 API
    await syncToBlog(noteData);

    syncedCount++;
    console.log(`✅ 已同步: ${noteData.title}`);
  }

  console.log(`\n📊 同步完成: ${syncedCount} 篇已发布，${skippedCount} 篇跳过`);
}

main().catch(console.error);
```

---

### 12.5 API 接口设计

#### 博客后端新增接口

**POST /api/admin/obsidian-sync**

**请求头：**
```
Authorization: Bearer {JWT_TOKEN}
Content-Type: application/json
```

**请求体：**
```json
{
  "title": "数据结构与算法",
  "slug": "shuju-jiegou-yu-suanfa",
  "content": "# 前言\n\n本篇笔记总结了...",
  "htmlContent": "<h1>前言</h1><p>本篇笔记总结了...</p>",
  "category": "tech",
  "tags": ["算法", "数据结构"],
  "cover": "https://cdn.example.com/covers/algorithm.png",
  "description": "本篇笔记总结了核心数据结构...",
  "date": "2025-01-15T00:00:00Z",
  "obsidianPath": "3-Knowledge/T_工业技术/TP_计算机技术/数据结构与算法.md"
}
```

**响应：**
```json
{
  "success": true,
  "data": {
    "id": 123,
    "slug": "shuju-jiegou-yu-suanfa",
    "updatedAt": "2025-02-13T10:30:00Z"
  }
}
```

**后端处理逻辑：**
1. 验证 JWT 权限（必须是管理员）
2. 检查 slug 是否已存在：
   - 存在：更新内容（增量同步）
   - 不存在：创建新文章
3. 保存到数据库 `posts` 表
4. 触发 Astro 重新构建（SSG）
   - 或者：使用 ISR（增量静态再生）

---

### 12.6 CI/CD 自动同步

#### GitHub Actions 配置示例

```yaml
# .github/workflows/obsidian-sync.yml
name: Obsidian Sync

on:
  push:
    branches: [main]
    paths:
      - 'Documents/GardenOfOpeningClouds/**'
  workflow_dispatch:  # 支持手动触发

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Run sync script
        env:
          OBSIDIAN_TOKEN: ${{ secrets.OBSIDIAN_SYNC_TOKEN }}
        run: npm run obsidian:sync

      - name: Build blog
        run: npm run build

      - name: Deploy
        run: npm run deploy
```

---

### 12.7 手动同步命令

```bash
# 安装依赖
npm install

# 配置环境变量
cp .env.example .env
# 编辑 .env，填入博客 API Token

# 手动同步（开发测试）
npm run obsidian:sync

# 只同步指定文件夹
npm run obsidian:sync -- --path "3-Knowledge/T_工业技术/"

# 同步后预览
npm run dev
```

---

### 12.8 数据库变更

**`posts` 表新增字段（可选，用于追溯来源）：**

```sql
ALTER TABLE posts ADD COLUMN obsidian_path TEXT;         -- Obsidian 仓库路径
ALTER TABLE posts ADD COLUMN last_synced_at TEXT;        -- 最后同步时间
ALTER TABLE posts ADD COLUMN sync_source TEXT DEFAULT 'manual'; -- manual/obsidian
```

---

### 12.9 注意事项

1. **单向同步**：博客不回写 Obsidian，避免冲突
2. **幂等性**：多次同步同一笔记，结果应一致（更新而非重复创建）
3. **冲突处理**：
   - 如果博客已手动编辑文章，Obsidian 同步时提示"文章已修改，是否覆盖？"
   - 或在 frontmatter 添加 `sync_mode: 'overwrite' | 'skip' | 'merge'`
4. **图片安全**：
   - Obsidian 中的隐私图片不应被发布（检测到敏感路径时跳过）
   - 或使用 frontmatter `private: true` 标记
5. **性能优化**：
   - 增量同步：只同步修改过的笔记（通过 git commit time 或文件 mtime 判断）
   - 并发请求：批量同步时使用 `Promise.all`

---

### 12.10 开发任务清单

| 任务 | 优先级 | 说明 |
|------|-------|------|
| 配置文件与类型定义 | 🔴 高 | sync-config.json、types.ts |
| Markdown 解析器 | 🔴 高 | frontmatter 提取、标签提取 |
| 分类映射逻辑 | 🔴 高 | 中图法 → tech/learning/life |
| Slug 生成器 | 🔴 高 | 中文/英文处理、冲突检测 |
| 博客 API 接口 | 🔴 高 | POST /api/admin/obsidian-sync |
| 主同步脚本 | 🔴 高 | 遍历、解析、上传全流程 |
| 图片上传（图床） | 🟡 中 | Obsidian 内部图片转外链 |
| CI/CD 配置 | 🟡 中 | GitHub Actions 自动同步 |
| 增量同步优化 | 🟡 中 | 只同步修改过的笔记 |
| 冲突处理机制 | 🟢 低 | overwrite/skip/merge 选项 |
| 文档编写 | 🟢 低 | 使用说明、FAQ |

---

## 十三、阿里云部署方案 🆕

### 13.1 部署目标

从 **Cloudflare Workers** 迁移到 **阿里云 ECS（2核2G）**，采用前后端分离架构，实现博客的自主托管。

---

### 13.2 架构设计

#### 前后端分离架构图

```
                    ┌─────────────────┐
                    │   用户浏览器     │
                    └────────┬────────┘
                             │ HTTPS
                             ▼
                    ┌─────────────────┐
                    │    Nginx        │
                    │  (反向代理)      │
                    │  / → 静态资源    │
                    │  /api → 后端服务 │
                    └────────┬────────┘
                             │
            ┌────────────────┴────────────────┐
            ▼                                 ▼
┌─────────────────────┐           ┌─────────────────────┐
│   前端 (Astro SSG)   │           │   后端 (Node.js)     │
│  静态 HTML/CSS/JS    │           │   API 服务           │
│  构建后部署到:       │           │   Express/Fastify    │
│  /var/www/html/     │           │   端口: 3000         │
└─────────────────────┘           └────────┬────────────┘
                                            │
                                            ▼
                                   ┌─────────────────────┐
                                   │   数据库            │
                                   │   SQLite / PostgreSQL│
                                   │   文件: /data/blog.db│
                                   └─────────────────────┘
```

---

### 13.3 服务器配置

#### 基础信息
- **云服务商**：阿里云 ECS
- **规格**：2核 2GB 内存
- **操作系统**：Ubuntu 22.04 LTS
- **硬盘**：40GB SSD（系统盘 40GB）

#### 软件栈
- **前端**：Astro 4.x + SSG
- **后端**：Node.js 20.x + Express
- **数据库**：SQLite 3（资源限制，轻量级）或 PostgreSQL（后续可升级）
- **Web 服务器**：Nginx 1.24
- **容器化**：Docker + Docker Compose
- **进程管理**：PM2（备选方案，若不使用 Docker）

---

### 13.4 Docker Compose 部署

#### 目录结构
```
openingcloud-blog/
├── frontend/              # Astro 前端项目
├── backend/               # Node.js 后端项目
├── data/                  # 数据持久化目录
│   ├── sqlite/           # SQLite 数据库文件
│   └── uploads/           # 上传文件（图片等）
├── docker-compose.yml     # Docker Compose 配置
├── nginx/
│   └── nginx.conf        # Nginx 配置
└── scripts/
    └── deploy.sh         # 部署脚本
```

#### docker-compose.yml

```yaml
version: '3.8'

services:
  # 前端服务（Astro 构建产物）
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: openingcloud-frontend
    restart: unless-stopped
    volumes:
      - ./data/uploads:/app/public/uploads:ro  # 只读挂载上传目录
    networks:
      - blog-network
    environment:
      - NODE_ENV=production

  # 后端服务（API）
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: openingcloud-backend
    restart: unless-stopped
    ports:
      - "3000:3000"
    volumes:
      - ./data/sqlite:/app/data                # SQLite 数据库
      - ./data/uploads:/app/uploads            # 上传文件
    environment:
      - NODE_ENV=production
      - DATABASE_URL=file:/app/data/blog.db
      - JWT_SECRET=${JWT_SECRET}
      - ADMIN_EMAIL=${ADMIN_EMAIL}
      - ADMIN_PASSWORD=${ADMIN_PASSWORD}
    networks:
      - blog-network
    depends_on:
      - db-init

  # 数据库初始化（一次性任务）
  db-init:
    image: node:20-alpine
    container_name: openingcloud-db-init
    volumes:
      - ./data/sqlite:/app/data
    command: >
      sh -c "if [ ! -f /app/data/blog.db ]; then
             echo 'Initializing database...';
             cd /tmp && git clone https://github.com/hqy2020/openingcloud-blog.git &&
             cd openingcloud-blog/backend && npm ci &&
             node scripts/init-db.js /app/data/blog.db;
             else echo 'Database already exists'; fi"
    networks:
      - blog-network

  # Nginx（反向代理）
  nginx:
    image: nginx:1.24-alpine
    container_name: openingcloud-nginx
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro        # SSL 证书
    networks:
      - blog-network
    depends_on:
      - frontend
      - backend

networks:
  blog-network:
    driver: bridge
```

---

### 13.5 Nginx 配置

#### nginx.conf

```nginx
user nginx;
worker_processes auto;
error_log /var/log/nginx/error.log warn;
pid /var/run/nginx.pid;

events {
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    # 日志格式
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';

    access_log /var/log/nginx/access.log main;

    # 性能优化
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;
    client_max_body_size 10M;  # 上传文件大小限制

    # Gzip 压缩
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types text/plain text/css text/xml application/json application/javascript application/rss+xml;

    # HTTPS 配置（使用 Certbot 自动更新证书）
    server {
        listen 443 ssl http2;
        server_name blog.openingclouds.com;

        # SSL 证书（使用 Certbot）
        ssl_certificate /etc/nginx/ssl/fullchain.pem;
        ssl_certificate_key /etc/nginx/ssl/privkey.pem;

        # SSL 安全配置
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers HIGH:!aNULL:!MD5;
        ssl_prefer_server_ciphers on;

        # 安全头
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-XSS-Protection "1; mode=block" always;

        # 前端静态资源
        location / {
            proxy_pass http://frontend:80;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # 后端 API 代理
        location /api {
            proxy_pass http://backend:3000;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # API 超时配置
            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
        }

        # 静态缓存（图片、字体等）
        location ~* \.(jpg|jpeg|png|gif|ico|css|js|woff|woff2|svg)$ {
            proxy_pass http://frontend:80;
            expires 30d;
            add_header Cache-Control "public, immutable";
        }
    }

    # HTTP → HTTPS 重定向
    server {
        listen 80;
        server_name blog.openingclouds.com;
        return 301 https://$server_name$request_uri;
    }
}
```

---

### 13.6 数据库选择与优化

#### 方案对比

| 数据库 | 优势 | 劣势 | 推荐度 |
|--------|------|------|-------|
| **SQLite** | 轻量、零配置、2GB 内存友好 | 并发写入性能较弱 | ✅ 推荐（初期） |
| PostgreSQL | 功能强大、性能优秀 | 占用内存较大（~200-400MB） | ⚠️ 备选（后期） |
| MySQL | 兼容性好 | 占用内存较大 | ⚠️ 备选 |

#### 推荐方案：SQLite（初期）

**选择理由：**
- 博客是读多写少场景，SQLite 足够
- 2GB 内存下，SQLite 占用 < 50MB
- 迁移方便（直接复制 `.db` 文件）

**优化配置：**

```typescript
// backend/config/database.ts
import Database from 'better-sqlite3';
import { open } from 'sqlite';

const db = await open({
  filename: './data/blog.db',
  driver: Database,
  mode: 'readwrite',
  // 连接池配置（SQLite 使用 WAL 模式提升并发）
});

// WAL 模式（Write-Ahead Logging）
db.pragma('journal_mode = WAL');
db.pragma('synchronous = NORMAL');  // 平衡性能和安全
db.pragma('cache_size = -64000');   // 64MB 缓存
db.pragma('temp_store = memory');  // 临时表放内存
```

---

### 13.7 性能优化策略

#### 前端优化（Astro SSG）
1. **静态生成**：所有页面预渲染为 HTML
2. **代码分割**：路由级别懒加载
3. **图片优化**：
   - 使用 `@astrojs/image` 自动转换 WebP/AVIF
   - 响应式图片（srcset）
4. **CDN 加速**：静态资源上传到阿里云 OSS / Cloudflare CDN

#### 后端优化
1. **连接池**：数据库连接复用
2. **缓存策略**：
   - Redis（可选）：缓存热点数据
   - 内存缓存：文章列表、统计数据
3. **API 响应压缩**：Gzip/Brotli

#### Nginx 优化
1. **静态文件缓存**：图片、字体缓存 30 天
2. **Gzip 压缩**：所有文本资源
3. **反向代理缓存**：API 响应缓存（可选）

---

### 13.8 HTTPS 与域名配置

#### 域名配置
- **主域名**：`blog.openingclouds.com`
- **DNS 解析**：A 记录指向阿里云 ECS 公网 IP

#### SSL 证书自动更新（Certbot）

```bash
# 安装 Certbot
sudo apt update
sudo apt install certbot python3-certbot-nginx

# 获取证书（自动配置 Nginx）
sudo certbot --nginx -d blog.openingclouds.com

# 自动续期（定时任务）
sudo crontab -e
# 添加：0 0 * * 0 certbot renew --quiet
```

---

### 13.9 部署流程

#### 部署脚本（deploy.sh）

```bash
#!/bin/bash

set -e  # 遇到错误立即退出

echo "🚀 开始部署 openingClouds 博客..."

# 1. 拉取最新代码
echo "📥 拉取代码..."
git pull origin main

# 2. 构建前端
echo "🔨 构建前端 Astro..."
cd frontend
npm ci
npm run build
cd ..

# 3. 构建后端
echo "🔨 构建后端..."
cd backend
npm ci
npm run build
cd ..

# 4. 停止旧容器
echo "🛑 停止旧容器..."
docker-compose down

# 5. 启动新容器
echo "▶️ 启动新容器..."
docker-compose up -d

# 6. 等待服务启动
echo "⏳ 等待服务启动..."
sleep 10

# 7. 健康检查
echo "🏥 健康检查..."
if curl -f http://localhost:3000/api/health; then
    echo "✅ 后端服务正常"
else
    echo "❌ 后端服务异常"
    exit 1
fi

echo "🎉 部署完成！"
```

#### 自动化部署（GitHub Actions）

```yaml
# .github/workflows/deploy-aliyun.yml
name: Deploy to Aliyun

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Deploy to Aliyun ECS
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.ALIYUN_HOST }}
          username: ${{ secrets.ALIYUN_USERNAME }}
          key: ${{ secrets.ALIYUN_SSH_KEY }}
          script: |
            cd /root/openingcloud-blog
            git pull origin main
            ./deploy.sh
```

---

### 13.10 监控与日志

#### 日志收集
- **Nginx 访问日志**：`/var/log/nginx/access.log`
- **应用日志**：Docker 容器日志（`docker-compose logs`）
- **错误日志**：Sentry（可选）

#### 性能监控
- **系统监控**：`htop`、`vmstat`
- **容器监控**：`docker stats`
- **APM 工具**：New Relic / Datadog（可选）

---

### 13.11 备份策略

#### 数据库备份
```bash
#!/bin/bash
# scripts/backup-db.sh

BACKUP_DIR="/root/backups"
DATE=$(date +%Y%m%d_%H%M%S)
DB_FILE="/root/openingcloud-blog/data/sqlite/blog.db"

mkdir -p $BACKUP_DIR

# 备份数据库
cp $DB_FILE $BACKUP_DIR/blog_$DATE.db

# 压缩
gzip $BACKUP_DIR/blog_$DATE.db

# 删除 7 天前的备份
find $BACKUP_DIR -name "blog_*.db.gz" -mtime +7 -delete

echo "✅ 数据库备份完成: blog_$DATE.db.gz"
```

#### 定时备份（cron）
```bash
# 每天 2:00 备份
0 2 * * * /root/openingcloud-blog/scripts/backup-db.sh
```

---

### 13.12 成本估算

| 资源 | 配置 | 单价 | 年费 |
|------|------|------|------|
| 阿里云 ECS | 2核2G，40GB SSD | ~¥60/月 | ¥720/年 |
| 域名 | .com 域名 | ¥50/年 | ¥50/年 |
| SSL 证书 | Let's Encrypt | 免费 | ¥0 |
| OSS（可选） | 100GB 存储 | ~¥12/月 | ¥144/年 |

**总计**：¥864-1008/年

---

### 13.13 开发任务清单

| 任务 | 优先级 | 说明 |
|------|-------|------|
| Docker 容器化（前后端） | 🔴 高 | 编写 Dockerfile、docker-compose.yml |
| Nginx 配置与反向代理 | 🔴 高 | nginx.conf、SSL 配置 |
| 数据库迁移（Cloudflare D1 → SQLite） | 🔴 高 | 数据导出、Schema 转换 |
| 阿里云 ECS 购买与初始化 | 🔴 高 | 系统安装、环境配置 |
| 后端 API 服务开发 | 🔴 高 | Express、数据库 ORM（Prisma/Drizzle） |
| 前端构建与部署 | 🟡 中 | Astro SSG、静态资源优化 |
| SSL 证书配置 | 🟡 中 | Certbot 自动续期 |
| 部署脚本与 CI/CD | 🟡 中 | deploy.sh、GitHub Actions |
| 监控与日志收集 | 🟡 中 | 日志聚合、告警配置 |
| 备份策略实施 | 🟡 中 | 数据库备份脚本、定时任务 |
| 性能优化 | 🟢 低 | 缓存策略、CDN 配置 |
| 文档编写 | 🟢 低 | 部署文档、运维手册 |

---

## 变更记录

| 日期 | 版本 | 变更内容 |
|------|------|---------|
| 2026-02-13 | v1.0 | 初始版本，基于 Cloudflare Workers 架构 |
| 2026-02-13 | v2.0 | **新增第十一章：草地宠物交互系统** |
| 2026-02-13 | v2.0 | **新增第十二章：Obsidian 单向同步系统** |
| 2026-02-13 | v2.0 | **新增第十三章：阿里云部署方案** |
| 2026-02-13 | v2.0 | **更新 4.4 章节博客小宠物：标注草地交互功能** |
| 2026-02-13 | v2.0 | **更新第六章：数据库从 Cloudflare D1 改为 SQLite/PostgreSQL** |
| 2026-02-13 | v2.0 | **更新八、九章：新增草地精灵图素材需求** |

---

CCB_DONE: 20260213-222410-603-7138-1