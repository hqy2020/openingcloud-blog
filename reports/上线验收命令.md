# 上线验收命令（本轮变更）

> 目标：验证后台入口可发现性与 `UX-ADMIN-01~10`，并保留既有 `P1-MILE-05`、`P2-SEO-04`、`P2-API-06`、`P3-SYNC-03`、`P3-SYNC-04` 验收路径。

## 1. 发布前构建

```bash
cd /srv/openingcloud-blog
cd frontend && npm ci && npm run build && cd ..
```

## 2. 启动服务（HTTP）

```bash
cd /srv/openingcloud-blog
docker compose up -d --build
```

## 3. 启动服务（HTTPS）

```bash
cd /srv/openingcloud-blog
NGINX_CONF_FILE=./nginx/nginx.https.conf docker compose -f docker-compose.yml -f docker-compose.https.yml up -d --build
```

## 4. 网关与后台基础可达性验收

```bash
# API health
curl -i http://47.99.42.71/api/health | head -n 20

# sitemap 必须是 XML
curl -i https://blog.openingclouds.com/sitemap.xml | head -n 20

# admin 静态资源不应 404
curl -i https://blog.openingclouds.com/static/admin/css/base.css | head -n 20

# /admin/ 必须跳到登录页
curl -I http://47.99.42.71/admin/ | head -n 20

# admin 登录页应包含用户名/密码表单
curl -sS 'http://47.99.42.71/admin/login/?next=/admin/' \
  | rg -n 'name="username"|name="password"|type="submit"' -S
```

## 5. UX-ADMIN-入口可发现性（首页 CTA）

```bash
# 抽取首页主 bundle 文件名
ASSET_JS=$(curl -sS http://47.99.42.71/ | sed -n 's#.*src="/assets/\(index-[^"]*\.js\)".*#\1#p')
echo "$ASSET_JS"

# bundle 中应出现“后台管理”文案与 /admin/ 跳转
curl -sS "http://47.99.42.71/assets/${ASSET_JS}" | rg -n '后台管理|/admin/' -S
```

人工确认：
- 打开 `http://47.99.42.71/`，首屏应看到“后台管理”按钮。
- 点击后当前页跳转到 `/admin/`，并进入 Django Admin 登录流程。

## 6. UX-ADMIN-01（登录/退出 + 失败提示）

```bash
# API 登录失败反馈应明确（错误账号密码）
curl -i -X POST http://47.99.42.71/api/auth/login \
  -H 'Content-Type: application/json' \
  -d '{"username":"invalid-user","password":"invalid-pass"}'
```

人工确认：
- 在 `/admin/login/` 输入错误账号密码，页面出现失败提示。
- 用有效管理员账号登录成功后，点击右上角“退出登录”，回到登录态。

## 7. UX-ADMIN-02（仪表盘关键数据可读）

人工确认：
- 登录后访问 `/admin/`。
- 应看到“运营概览”，且包含文章、时间线、旅行、社交、高光、阅读量等关键统计。

## 8. UX-ADMIN-03 ~ UX-ADMIN-08（六大模块核心操作）

口径：仪表盘 + 5 个内容模块（文章、旅行、社交、人生线、高光）。

人工操作矩阵（每项至少完成 1 次）：
- 文章：筛选、新增、编辑、删除。
- 旅行：筛选、新增、编辑、删除、排序。
- 社交：筛选、新增、编辑、删除、排序。
- 人生线：筛选、新增、编辑、删除、排序。
- 高光：阶段新增/编辑/删除/排序；阶段内条目新增/编辑/删除/排序（inline）。

## 9. UX-ADMIN-10（成功/失败反馈）

人工确认：
- 成功新增或编辑后出现 Django Admin 成功提示。
- 故意触发表单失败（如必填为空）后出现字段级或表单级错误提示。

## 10. 上传与同步接口验收（保留）

```bash
# 先登录拿 cookie（示例）
curl -i -c /tmp/oc_cookie.txt -H 'Content-Type: application/json' \
  -d '{"username":"admin","password":"<password>"}' \
  https://blog.openingclouds.com/api/auth/login

# 上传图片（P2-API-06）
curl -i -b /tmp/oc_cookie.txt -c /tmp/oc_cookie.txt \
  -F "file=@/tmp/test.png;type=image/png" \
  https://blog.openingclouds.com/api/admin/images/

# 同步 API（P3-SYNC-03）
curl -i -b /tmp/oc_cookie.txt -c /tmp/oc_cookie.txt \
  -H 'Content-Type: application/json' \
  -d '{
    "title":"API 同步验收",
    "slug":"api-sync-check",
    "content":"# hello",
    "category":"tech",
    "tags":["sync"],
    "mode":"overwrite",
    "obsidian_path":"checks/api-sync-check.md"
  }' \
  https://blog.openingclouds.com/api/admin/obsidian-sync/
```

## 11. 同步日志验收（P3-SYNC-04）

```bash
cd /srv/openingcloud-blog
docker compose exec backend python manage.py shell -c "from blog.models import SyncLog; print(SyncLog.objects.order_by('-id').values('id','slug','source','mode','action','status')[:5])"
```

## 12. 本地自动化回归

```bash
cd /srv/openingcloud-blog
source backend/.venv/bin/activate
cd backend && python manage.py test && cd ..
cd frontend && npm run lint && npm run build && npm run lighthouse:mobile
```
