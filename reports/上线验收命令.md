# 上线验收命令（本轮变更）

> 目标：验证 `P1-MILE-05`、`P2-SEO-04`、`P2-API-06`、`P3-SYNC-03`、`P3-SYNC-04`

## 1. 发布前构建

```bash
cd /srv/openingcloud-blog
cd frontend && npm ci && npm run build && cd ..
```

## 2. 启动服务（HTTP）

```bash
cd /srv/openingcloud-blog
docker compose up -d --build
```

## 3. 启动服务（HTTPS）

```bash
cd /srv/openingcloud-blog
NGINX_CONF_FILE=./nginx/nginx.https.conf docker compose -f docker-compose.yml -f docker-compose.https.yml up -d --build
```

## 4. 网关验收（sitemap + admin static）

```bash
# sitemap 必须是 XML
curl -i https://blog.openingclouds.com/sitemap.xml | head -n 20

# admin 静态资源不应 404
curl -i https://blog.openingclouds.com/static/admin/css/base.css | head -n 20
```

## 5. 上传接口验收（P2-API-06）

```bash
# 先登录拿 cookie（示例）
curl -i -c /tmp/oc_cookie.txt -H 'Content-Type: application/json' \
  -d '{"username":"admin","password":"<password>"}' \
  https://blog.openingclouds.com/api/auth/login

# 上传图片
curl -i -b /tmp/oc_cookie.txt -c /tmp/oc_cookie.txt \
  -F "file=@/tmp/test.png;type=image/png" \
  https://blog.openingclouds.com/api/admin/images/
```

## 6. 同步 API 验收（P3-SYNC-03）

```bash
curl -i -b /tmp/oc_cookie.txt -c /tmp/oc_cookie.txt \
  -H 'Content-Type: application/json' \
  -d '{
    "title":"API 同步验收",
    "slug":"api-sync-check",
    "content":"# hello",
    "category":"tech",
    "tags":["sync"],
    "mode":"overwrite",
    "obsidian_path":"checks/api-sync-check.md"
  }' \
  https://blog.openingclouds.com/api/admin/obsidian-sync/
```

## 7. 同步日志验收（P3-SYNC-04）

```bash
cd /srv/openingcloud-blog
docker compose exec backend python manage.py shell -c "from blog.models import SyncLog; print(SyncLog.objects.order_by('-id').values('id','slug','source','mode','action','status')[:5])"
```

## 8. 本地自动化回归

```bash
cd /srv/openingcloud-blog
source backend/.venv/bin/activate
cd backend && python manage.py test && cd ..
cd frontend && npm run lint && npm run build && npm run lighthouse:mobile
```
