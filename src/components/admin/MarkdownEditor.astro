---
// MarkdownEditor.astro â€” å·¦å³åˆ†æ  Markdown ç¼–è¾‘å™¨ï¼ˆå®æ—¶é¢„è§ˆ + å·¥å…·æ  + å›¾ç‰‡ä¸Šä¼ ï¼‰
interface Props {
  content?: string;
}

const { content = '' } = Astro.props;
---

<!-- å·¥å…·æ  -->
<div class="flex flex-wrap gap-1 mb-2 p-2 bg-gray-50 dark:bg-gray-800 rounded-t-lg border border-b-0 border-gray-300 dark:border-gray-600">
  <button type="button" data-action="h1" class="toolbar-btn" title="ä¸€çº§æ ‡é¢˜">H1</button>
  <button type="button" data-action="h2" class="toolbar-btn" title="äºŒçº§æ ‡é¢˜">H2</button>
  <button type="button" data-action="h3" class="toolbar-btn" title="ä¸‰çº§æ ‡é¢˜">H3</button>
  <span class="w-px h-6 bg-gray-300 dark:bg-gray-600 mx-1 self-center"></span>
  <button type="button" data-action="bold" class="toolbar-btn" title="åŠ ç²—"><b>B</b></button>
  <button type="button" data-action="italic" class="toolbar-btn" title="æ–œä½“"><i>I</i></button>
  <button type="button" data-action="code" class="toolbar-btn" title="è¡Œå†…ä»£ç ">&lt;/&gt;</button>
  <button type="button" data-action="codeblock" class="toolbar-btn" title="ä»£ç å—">```</button>
  <span class="w-px h-6 bg-gray-300 dark:bg-gray-600 mx-1 self-center"></span>
  <button type="button" data-action="link" class="toolbar-btn" title="é“¾æ¥">ğŸ”—</button>
  <button type="button" data-action="ul" class="toolbar-btn" title="æ— åºåˆ—è¡¨">â€¢ List</button>
  <button type="button" data-action="ol" class="toolbar-btn" title="æœ‰åºåˆ—è¡¨">1. List</button>
  <span class="w-px h-6 bg-gray-300 dark:bg-gray-600 mx-1 self-center"></span>
  <button type="button" data-action="image" class="toolbar-btn" title="æ’å…¥å›¾ç‰‡">ğŸ–¼</button>
  <label class="toolbar-btn cursor-pointer" title="ä¸Šä¼ å›¾ç‰‡">
    ğŸ“¤
    <input type="file" id="editor-file-input" accept="image/*" class="hidden" />
  </label>
</div>

<!-- ç¼–è¾‘å™¨ä¸»ä½“ï¼šå·¦å³åˆ†æ  -->
<div class="flex flex-col lg:flex-row gap-0 border border-gray-300 dark:border-gray-600 rounded-b-lg overflow-hidden" style="min-height: 500px;">
  <!-- ç¼–è¾‘åŒº -->
  <div class="flex-1 relative">
    <textarea
      id="md-editor"
      class="w-full h-full min-h-[500px] p-4 bg-white dark:bg-gray-900 text-text-light dark:text-text-dark font-mono text-sm resize-none outline-none border-r border-gray-300 dark:border-gray-600"
      placeholder="åœ¨æ­¤è¾“å…¥ Markdown..."
    >{content}</textarea>
  </div>
  <!-- é¢„è§ˆåŒº -->
  <div class="flex-1 p-4 bg-white dark:bg-gray-900 overflow-y-auto prose dark:prose-invert max-w-none" id="md-preview">
    <p class="text-gray-400">é¢„è§ˆåŒºåŸŸ</p>
  </div>
</div>

<!-- è‡ªåŠ¨ä¿å­˜æç¤º -->
<div id="autosave-status" class="text-xs text-gray-400 mt-1 text-right"></div>

<style>
  .toolbar-btn {
    padding: 0.25rem 0.5rem;
    border-radius: 0.375rem;
    font-size: 0.75rem;
    color: var(--color-text-light);
    transition: background-color 0.15s;
    cursor: pointer;
  }
  :where(.dark, .dark *) .toolbar-btn {
    color: var(--color-text-dark);
  }
  .toolbar-btn:hover {
    background-color: #e5e7eb;
  }
  :where(.dark, .dark *) .toolbar-btn:hover {
    background-color: #374151;
  }
</style>

<script is:inline src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script is:inline>
(function() {
  var editor = document.getElementById('md-editor');
  var preview = document.getElementById('md-preview');
  var autosaveEl = document.getElementById('autosave-status');
  var fileInput = document.getElementById('editor-file-input');

  // è‡ªåŠ¨ä¿å­˜ keyï¼ˆåŸºäº URLï¼‰
  var draftKey = 'draft:' + window.location.pathname;

  // åˆå§‹åŒ–ï¼šå¦‚æœç¼–è¾‘å™¨ä¸ºç©ºï¼Œå°è¯•æ¢å¤è‰ç¨¿
  if (!editor.value.trim()) {
    var saved = localStorage.getItem(draftKey);
    if (saved) editor.value = saved;
  }

  // å®æ—¶é¢„è§ˆ
  function updatePreview() {
    preview.innerHTML = marked.parse(editor.value || '');
  }

  // è‡ªåŠ¨ä¿å­˜åˆ° localStorage
  var saveTimeout;
  function scheduleSave() {
    clearTimeout(saveTimeout);
    saveTimeout = setTimeout(function() {
      localStorage.setItem(draftKey, editor.value);
      autosaveEl.textContent = 'å·²æš‚å­˜ ' + new Date().toLocaleTimeString();
    }, 1000);
  }

  editor.addEventListener('input', function() {
    updatePreview();
    scheduleSave();
  });

  // åˆå§‹é¢„è§ˆ
  updatePreview();

  // å·¥å…·æ æ“ä½œ
  function insertAtCursor(before, after) {
    var start = editor.selectionStart;
    var end = editor.selectionEnd;
    var selected = editor.value.substring(start, end);
    var replacement = before + (selected || '') + (after || '');
    editor.value = editor.value.substring(0, start) + replacement + editor.value.substring(end);
    editor.selectionStart = start + before.length;
    editor.selectionEnd = start + before.length + selected.length;
    editor.focus();
    updatePreview();
    scheduleSave();
  }

  function insertAtLineStart(prefix) {
    var start = editor.selectionStart;
    var lineStart = editor.value.lastIndexOf('\n', start - 1) + 1;
    editor.value = editor.value.substring(0, lineStart) + prefix + editor.value.substring(lineStart);
    editor.selectionStart = editor.selectionEnd = start + prefix.length;
    editor.focus();
    updatePreview();
    scheduleSave();
  }

  var actions = {
    h1: function() { insertAtLineStart('# '); },
    h2: function() { insertAtLineStart('## '); },
    h3: function() { insertAtLineStart('### '); },
    bold: function() { insertAtCursor('**', '**'); },
    italic: function() { insertAtCursor('*', '*'); },
    code: function() { insertAtCursor('`', '`'); },
    codeblock: function() { insertAtCursor('\n```\n', '\n```\n'); },
    link: function() { insertAtCursor('[', '](url)'); },
    ul: function() { insertAtLineStart('- '); },
    ol: function() { insertAtLineStart('1. '); },
    image: function() { insertAtCursor('![alt](', ')'); },
  };

  document.querySelectorAll('[data-action]').forEach(function(btn) {
    btn.addEventListener('click', function() {
      var action = this.getAttribute('data-action');
      if (actions[action]) actions[action]();
    });
  });

  // å›¾ç‰‡ä¸Šä¼ 
  async function uploadImage(file) {
    var formData = new FormData();
    formData.append('file', file);
    try {
      var res = await fetch('/api/admin/images', { method: 'POST', body: formData });
      var data = await res.json();
      if (data.ok) {
        insertAtCursor('![' + file.name + '](', data.data.url + ')');
      } else {
        alert('ä¸Šä¼ å¤±è´¥: ' + (data.error?.message || 'æœªçŸ¥é”™è¯¯'));
      }
    } catch (e) {
      alert('ä¸Šä¼ å¤±è´¥: ç½‘ç»œé”™è¯¯');
    }
  }

  // æ–‡ä»¶é€‰æ‹©ä¸Šä¼ 
  fileInput.addEventListener('change', function() {
    if (this.files[0]) uploadImage(this.files[0]);
    this.value = '';
  });

  // æ‹–æ‹½ä¸Šä¼ 
  editor.addEventListener('dragover', function(e) { e.preventDefault(); });
  editor.addEventListener('drop', function(e) {
    e.preventDefault();
    var files = e.dataTransfer.files;
    for (var i = 0; i < files.length; i++) {
      if (files[i].type.startsWith('image/')) uploadImage(files[i]);
    }
  });

  // ç²˜è´´ä¸Šä¼ 
  editor.addEventListener('paste', function(e) {
    var items = e.clipboardData?.items;
    if (!items) return;
    for (var i = 0; i < items.length; i++) {
      if (items[i].type.startsWith('image/')) {
        e.preventDefault();
        uploadImage(items[i].getAsFile());
        return;
      }
    }
  });

  // Tab é”®æ”¯æŒç¼©è¿›
  editor.addEventListener('keydown', function(e) {
    if (e.key === 'Tab') {
      e.preventDefault();
      insertAtCursor('  ', '');
    }
  });

  // æš´éœ²è·å–å†…å®¹çš„æ–¹æ³•ä¾›è¡¨å•ä½¿ç”¨
  window.getEditorContent = function() { return editor.value; };
  window.clearEditorDraft = function() { localStorage.removeItem(draftKey); };
})();
</script>
