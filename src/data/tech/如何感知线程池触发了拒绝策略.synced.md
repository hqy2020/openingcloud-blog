---
title: "如何感知线程池触发了拒绝策略"
description: "通过代理模式实现增强型线程池和拒绝策略代理感知拒绝事件"
date: 2026-02-11
category: tech
tags: [并发编程]
---

# 如何感知线程池触发了拒绝策略？

## 回答话术

在高并发场景下，线程池可能触发拒绝策略。当线程池处于非运行状态，或阻塞队列已满且已创建最大线程数时，会触发拒绝。线程池 API 原生不支持拒绝策略扩展（reject 方法为默认访问权限 + final 修饰），但可通过**代理模式**实现监控需求：自定义增强型线程池记录拒绝次数，代理拒绝策略在执行前触发告警。

## 问题详解

### 核心问题

JDK 线程池的 `reject()` 方法设置了限制性权限，无法直接继承重写：

```java
final void reject(Runnable command) {
    handler.rejectedExecution(command, this);
}
```

### 解决方案：代理模式

**第一步：创建增强型线程池**

```java
public class SupportThreadPoolExecutor extends ThreadPoolExecutor {
    private final AtomicInteger rejectCount = new AtomicInteger();

    public void incrementRejectCount() {
        rejectCount.incrementAndGet();
    }

    public int getRejectCount() {
        return rejectCount.get();
    }
}
```

**第二步：实现代理拒绝策略**

```java
public class RejectedHandlerProxy implements RejectedExecutionHandler {
    private RejectedExecutionHandler delegate;

    @Override
    public void rejectedExecution(Runnable runnable, ThreadPoolExecutor executor) {
        beforeReject(executor);
        delegate.rejectedExecution(runnable, executor);
    }

    private void beforeReject(ThreadPoolExecutor executor) {
        if (executor instanceof SupportThreadPoolExecutor) {
            SupportThreadPoolExecutor supportExecutor =
                (SupportThreadPoolExecutor) executor;
            supportExecutor.incrementRejectCount();
            // 发送报警消息或邮件通知
            System.out.println("线程池触发了任务拒绝...");
        }
    }
}
```

## 关键要点

- 拒绝触发条件：线程池停止，或队列满 + 达到最大线程数
- 设计限制：原生 API 的 reject 方法为 final 且默认访问权限，无法扩展
- 解决方案：代理模式包装拒绝策略，在执行前插入监控逻辑
- 主要功能：统计拒绝次数、发送报警、记录指标
- 实现原理：自定义线程池 + 代理处理器组合
