---
export const prerender = false;
/**
 * æ—¥è®°æ•°æ®ç®¡ç† â€” æ—¥å†è§†å›¾ + è¡¨æ ¼è§†å›¾ + å¿«é€Ÿå½•å…¥
 */
import AdminLayout from '@/components/admin/AdminLayout.astro';
---

<AdminLayout title="æ—¥è®°æ•°æ®">
  <div class="space-y-6">
    <!-- é¡¶éƒ¨æ“ä½œæ  -->
    <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
      <h1 class="text-2xl font-bold">ğŸ“Š æ—¥è®°æ•°æ®</h1>
      <div class="flex items-center gap-3">
        <div class="flex items-center gap-2 text-sm">
          <label class="text-gray-500">æ—¥æœŸèŒƒå›´:</label>
          <input type="date" id="filter-from" class="border border-gray-300 dark:border-gray-600 rounded px-2 py-1 text-sm bg-white dark:bg-slate-800" />
          <span class="text-gray-400">~</span>
          <input type="date" id="filter-to" class="border border-gray-300 dark:border-gray-600 rounded px-2 py-1 text-sm bg-white dark:bg-slate-800" />
        </div>
        <button id="btn-add" class="px-4 py-2 bg-primary-500 text-white rounded-lg text-sm hover:bg-primary-600 transition-colors cursor-pointer">
          + æ–°å¢è®°å½•
        </button>
      </div>
    </div>

    <!-- ç»Ÿè®¡æ¦‚è§ˆ -->
    <div id="stats-panel" class="grid grid-cols-2 md:grid-cols-5 gap-3">
      <div class="bg-white dark:bg-slate-800 rounded-lg p-3 border border-gray-200 dark:border-gray-700 text-center">
        <div class="text-xs text-gray-400 mb-1">è®°å½•å¤©æ•°</div>
        <div id="stat-count" class="text-xl font-bold text-primary-500">-</div>
      </div>
      <div class="bg-white dark:bg-slate-800 rounded-lg p-3 border border-gray-200 dark:border-gray-700 text-center">
        <div class="text-xs text-gray-400 mb-1">å¹³å‡æ­¥æ•°</div>
        <div id="stat-steps" class="text-xl font-bold text-grass-500">-</div>
      </div>
      <div class="bg-white dark:bg-slate-800 rounded-lg p-3 border border-gray-200 dark:border-gray-700 text-center">
        <div class="text-xs text-gray-400 mb-1">å¹³å‡ç¡çœ </div>
        <div id="stat-sleep" class="text-xl font-bold text-primary-400">-</div>
      </div>
      <div class="bg-white dark:bg-slate-800 rounded-lg p-3 border border-gray-200 dark:border-gray-700 text-center">
        <div class="text-xs text-gray-400 mb-1">å¹³å‡ä¸“æ³¨</div>
        <div id="stat-focus" class="text-xl font-bold text-sun-400">-</div>
      </div>
      <div class="bg-white dark:bg-slate-800 rounded-lg p-3 border border-gray-200 dark:border-gray-700 text-center">
        <div class="text-xs text-gray-400 mb-1">å¹³å‡å¿ƒæƒ…</div>
        <div id="stat-mood" class="text-xl font-bold text-primary-500">-</div>
      </div>
    </div>

    <!-- æ•°æ®è¡¨æ ¼ -->
    <div class="bg-white dark:bg-slate-800 rounded-lg border border-gray-200 dark:border-gray-700 overflow-hidden">
      <div class="overflow-x-auto">
        <table class="w-full text-sm">
          <thead class="bg-gray-50 dark:bg-slate-900/50">
            <tr>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">æ—¥æœŸ</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">æ­¥æ•°</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ç¡çœ </th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ä¸“æ³¨</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">è¿åŠ¨</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">å¿ƒæƒ…</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">å¤‡æ³¨</th>
              <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">æ“ä½œ</th>
            </tr>
          </thead>
          <tbody id="diary-table-body" class="divide-y divide-gray-200 dark:divide-gray-700">
            <tr><td colspan="8" class="px-4 py-8 text-center text-gray-400">åŠ è½½ä¸­...</td></tr>
          </tbody>
        </table>
      </div>
      <!-- åˆ†é¡µ -->
      <div id="pagination" class="flex items-center justify-between px-4 py-3 border-t border-gray-200 dark:border-gray-700">
        <span id="page-info" class="text-sm text-gray-500"></span>
        <div class="flex gap-2">
          <button id="btn-prev" class="px-3 py-1 text-sm border rounded hover:bg-gray-100 dark:hover:bg-gray-700 disabled:opacity-50 cursor-pointer" disabled>ä¸Šä¸€é¡µ</button>
          <button id="btn-next" class="px-3 py-1 text-sm border rounded hover:bg-gray-100 dark:hover:bg-gray-700 disabled:opacity-50 cursor-pointer" disabled>ä¸‹ä¸€é¡µ</button>
        </div>
      </div>
    </div>
  </div>

  <!-- æ–°å¢/ç¼–è¾‘å¼¹çª— -->
  <div id="diary-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/50">
    <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-xl w-full max-w-lg mx-4 p-6">
      <h3 id="modal-title" class="text-lg font-bold mb-4">æ–°å¢æ—¥è®°è®°å½•</h3>
      <form id="diary-form" class="space-y-4">
        <input type="hidden" id="form-id" />
        <div>
          <label class="block text-sm font-medium mb-1">æ—¥æœŸ *</label>
          <input type="date" id="form-date" class="w-full border border-gray-300 dark:border-gray-600 rounded-lg px-3 py-2 bg-white dark:bg-slate-900" required />
        </div>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium mb-1">ğŸ‘Ÿ æ­¥æ•°</label>
            <input type="number" id="form-steps" class="w-full border border-gray-300 dark:border-gray-600 rounded-lg px-3 py-2 bg-white dark:bg-slate-900" min="0" />
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">ğŸ˜´ ç¡çœ  (å°æ—¶)</label>
            <input type="number" id="form-sleep" class="w-full border border-gray-300 dark:border-gray-600 rounded-lg px-3 py-2 bg-white dark:bg-slate-900" min="0" max="24" step="0.1" />
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">ğŸ¯ ä¸“æ³¨ (å°æ—¶)</label>
            <input type="number" id="form-focus" class="w-full border border-gray-300 dark:border-gray-600 rounded-lg px-3 py-2 bg-white dark:bg-slate-900" min="0" max="24" step="0.1" />
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">ğŸƒ è¿åŠ¨ (åˆ†é’Ÿ)</label>
            <input type="number" id="form-exercise" class="w-full border border-gray-300 dark:border-gray-600 rounded-lg px-3 py-2 bg-white dark:bg-slate-900" min="0" />
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">å¿ƒæƒ…</label>
          <div id="mood-selector" class="flex gap-2">
            {[1,2,3,4,5].map(m => (
              <button type="button" data-mood={m} class="mood-btn w-10 h-10 rounded-full border-2 border-gray-200 dark:border-gray-600 text-lg hover:border-primary-400 transition-colors cursor-pointer">
                {['ğŸ˜','ğŸ˜','ğŸ™‚','ğŸ˜Š','ğŸ¤©'][m-1]}
              </button>
            ))}
          </div>
          <input type="hidden" id="form-mood" />
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">å¤‡æ³¨</label>
          <textarea id="form-note" class="w-full border border-gray-300 dark:border-gray-600 rounded-lg px-3 py-2 bg-white dark:bg-slate-900" rows="2"></textarea>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">æ ‡ç­¾ (é€—å·åˆ†éš”)</label>
          <input type="text" id="form-tags" class="w-full border border-gray-300 dark:border-gray-600 rounded-lg px-3 py-2 bg-white dark:bg-slate-900" placeholder="é«˜æ•ˆ, è¿åŠ¨" />
        </div>
        <div class="flex justify-end gap-3 pt-2">
          <button type="button" id="btn-cancel" class="px-4 py-2 text-sm text-gray-600 hover:text-gray-800 cursor-pointer">å–æ¶ˆ</button>
          <button type="submit" class="px-4 py-2 bg-primary-500 text-white rounded-lg text-sm hover:bg-primary-600 cursor-pointer">ä¿å­˜</button>
        </div>
      </form>
    </div>
  </div>
</AdminLayout>

<script is:inline>
(function() {
  let currentPage = 1;
  const pageSize = 20;

  // Elements
  const tbody = document.getElementById('diary-table-body');
  const pageInfo = document.getElementById('page-info');
  const btnPrev = document.getElementById('btn-prev');
  const btnNext = document.getElementById('btn-next');
  const modal = document.getElementById('diary-modal');
  const form = document.getElementById('diary-form');
  const filterFrom = document.getElementById('filter-from');
  const filterTo = document.getElementById('filter-to');

  // Mood selector
  let selectedMood = null;
  document.querySelectorAll('.mood-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      selectedMood = parseInt(btn.dataset.mood);
      document.getElementById('form-mood').value = selectedMood;
      document.querySelectorAll('.mood-btn').forEach(b => b.classList.remove('border-primary-500', 'bg-primary-50'));
      btn.classList.add('border-primary-500', 'bg-primary-50');
    });
  });

  const moodEmoji = ['', 'ğŸ˜','ğŸ˜','ğŸ™‚','ğŸ˜Š','ğŸ¤©'];

  async function loadEntries() {
    const params = new URLSearchParams({ page: currentPage, pageSize });
    if (filterFrom.value) params.set('from', filterFrom.value);
    if (filterTo.value) params.set('to', filterTo.value);

    const res = await fetch('/api/admin/diary?' + params);
    const json = await res.json();
    if (!json.ok) return;

    const { entries, total, page } = json.data;
    const totalPages = Math.ceil(total / pageSize);

    pageInfo.textContent = `ç¬¬ ${page} / ${totalPages} é¡µ (å…± ${total} æ¡)`;
    btnPrev.disabled = page <= 1;
    btnNext.disabled = page >= totalPages;

    if (entries.length === 0) {
      tbody.innerHTML = '<tr><td colspan="8" class="px-4 py-8 text-center text-gray-400">æš‚æ— æ•°æ®</td></tr>';
      return;
    }

    tbody.innerHTML = entries.map(e => `
      <tr class="hover:bg-gray-50 dark:hover:bg-slate-700/50">
        <td class="px-4 py-3 font-medium">${e.date}</td>
        <td class="px-4 py-3">${e.steps ?? '-'}</td>
        <td class="px-4 py-3">${e.sleep_hours != null ? e.sleep_hours + 'h' : '-'}</td>
        <td class="px-4 py-3">${e.focus_hours != null ? e.focus_hours + 'h' : '-'}</td>
        <td class="px-4 py-3">${e.exercise_minutes != null ? e.exercise_minutes + 'min' : '-'}</td>
        <td class="px-4 py-3">${e.mood ? moodEmoji[e.mood] : '-'}</td>
        <td class="px-4 py-3 max-w-[200px] truncate text-gray-500">${e.note || ''}</td>
        <td class="px-4 py-3 text-right">
          <button onclick="editEntry(${e.id})" class="text-primary-500 hover:text-primary-600 text-sm mr-2 cursor-pointer">ç¼–è¾‘</button>
          <button onclick="deleteEntry(${e.id})" class="text-red-500 hover:text-red-600 text-sm cursor-pointer">åˆ é™¤</button>
        </td>
      </tr>
    `).join('');
  }

  async function loadStats() {
    const params = new URLSearchParams();
    if (filterFrom.value) params.set('from', filterFrom.value);
    if (filterTo.value) params.set('to', filterTo.value);

    const res = await fetch('/api/admin/diary/stats?' + params);
    const json = await res.json();
    if (!json.ok) return;
    const s = json.data;

    document.getElementById('stat-count').textContent = s.count || '0';
    document.getElementById('stat-steps').textContent = s.avg_steps ? Math.round(s.avg_steps).toLocaleString() : '-';
    document.getElementById('stat-sleep').textContent = s.avg_sleep ? s.avg_sleep.toFixed(1) + 'h' : '-';
    document.getElementById('stat-focus').textContent = s.avg_focus ? s.avg_focus.toFixed(1) + 'h' : '-';
    document.getElementById('stat-mood').textContent = s.avg_mood ? moodEmoji[Math.round(s.avg_mood)] : '-';
  }

  function openModal(entry) {
    document.getElementById('modal-title').textContent = entry ? 'ç¼–è¾‘æ—¥è®°è®°å½•' : 'æ–°å¢æ—¥è®°è®°å½•';
    document.getElementById('form-id').value = entry ? entry.id : '';
    document.getElementById('form-date').value = entry ? entry.date : new Date().toISOString().split('T')[0];
    document.getElementById('form-steps').value = entry?.steps ?? '';
    document.getElementById('form-sleep').value = entry?.sleep_hours ?? '';
    document.getElementById('form-focus').value = entry?.focus_hours ?? '';
    document.getElementById('form-exercise').value = entry?.exercise_minutes ?? '';
    document.getElementById('form-note').value = entry?.note ?? '';
    document.getElementById('form-tags').value = entry ? JSON.parse(entry.tags || '[]').join(', ') : '';

    selectedMood = entry?.mood || null;
    document.getElementById('form-mood').value = selectedMood || '';
    document.querySelectorAll('.mood-btn').forEach(b => {
      b.classList.toggle('border-primary-500', parseInt(b.dataset.mood) === selectedMood);
      b.classList.toggle('bg-primary-50', parseInt(b.dataset.mood) === selectedMood);
    });

    modal.classList.remove('hidden');
  }

  window.editEntry = async function(id) {
    const res = await fetch('/api/admin/diary/' + id);
    const json = await res.json();
    if (json.ok) openModal(json.data);
  };

  window.deleteEntry = async function(id) {
    if (!confirm('ç¡®å®šåˆ é™¤æ­¤æ¡è®°å½•ï¼Ÿ')) return;
    await fetch('/api/admin/diary/' + id, { method: 'DELETE' });
    loadEntries();
    loadStats();
  };

  document.getElementById('btn-add').addEventListener('click', () => openModal(null));
  document.getElementById('btn-cancel').addEventListener('click', () => modal.classList.add('hidden'));
  modal.addEventListener('click', e => { if (e.target === modal) modal.classList.add('hidden'); });

  btnPrev.addEventListener('click', () => { currentPage--; loadEntries(); });
  btnNext.addEventListener('click', () => { currentPage++; loadEntries(); });

  filterFrom.addEventListener('change', () => { currentPage = 1; loadEntries(); loadStats(); });
  filterTo.addEventListener('change', () => { currentPage = 1; loadEntries(); loadStats(); });

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const id = document.getElementById('form-id').value;
    const data = {
      date: document.getElementById('form-date').value,
      steps: document.getElementById('form-steps').value ? parseInt(document.getElementById('form-steps').value) : null,
      sleep_hours: document.getElementById('form-sleep').value ? parseFloat(document.getElementById('form-sleep').value) : null,
      focus_hours: document.getElementById('form-focus').value ? parseFloat(document.getElementById('form-focus').value) : null,
      exercise_minutes: document.getElementById('form-exercise').value ? parseInt(document.getElementById('form-exercise').value) : null,
      mood: document.getElementById('form-mood').value ? parseInt(document.getElementById('form-mood').value) : null,
      note: document.getElementById('form-note').value || null,
      tags: document.getElementById('form-tags').value ? document.getElementById('form-tags').value.split(',').map(t => t.trim()).filter(Boolean) : [],
    };

    const url = id ? '/api/admin/diary/' + id : '/api/admin/diary';
    const method = id ? 'PUT' : 'POST';
    const res = await fetch(url, { method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
    const json = await res.json();

    if (json.ok) {
      modal.classList.add('hidden');
      loadEntries();
      loadStats();
    } else {
      alert(json.error?.message || 'ä¿å­˜å¤±è´¥');
    }
  });

  loadEntries();
  loadStats();
})();
</script>
