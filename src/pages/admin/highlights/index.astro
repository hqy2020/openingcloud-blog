---
export const prerender = false;
import AdminLayout from '@/components/admin/AdminLayout.astro';
---

<AdminLayout title="高光时刻管理">
  <div class="space-y-6">
    <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
      <h1 class="text-2xl font-bold">⭐ 高光时刻管理</h1>
      <button id="btn-add-stage" class="px-4 py-2 bg-primary-500 text-white rounded-lg text-sm hover:bg-primary-600 transition-colors cursor-pointer">+ 新增阶段</button>
    </div>

    <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
      <div class="rounded-xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-slate-800 p-3 text-center">
        <div class="text-xs text-gray-500">阶段数量</div>
        <div id="stat-stage" class="text-xl font-bold mt-1">-</div>
      </div>
      <div class="rounded-xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-slate-800 p-3 text-center">
        <div class="text-xs text-gray-500">成就条目</div>
        <div id="stat-item" class="text-xl font-bold mt-1">-</div>
      </div>
      <div class="rounded-xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-slate-800 p-3 text-center">
        <div class="text-xs text-gray-500">平均每阶段</div>
        <div id="stat-avg" class="text-xl font-bold mt-1">-</div>
      </div>
      <div class="rounded-xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-slate-800 p-3 text-center">
        <div class="text-xs text-gray-500">状态</div>
        <div class="text-sm font-medium mt-2 text-primary-500">可编辑</div>
      </div>
    </div>

    <div id="highlight-list" class="space-y-4">
      <div class="rounded-xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-slate-800 p-6 text-center text-gray-400">加载中...</div>
    </div>
  </div>
</AdminLayout>

<script is:inline>
(function() {
  const list = document.getElementById('highlight-list');

  async function loadData() {
    const res = await fetch('/api/admin/highlights');
    const json = await res.json();
    if (!json.ok) return;

    const stages = json.data;
    renderStats(stages);
    renderList(stages);
  }

  function renderStats(stages) {
    const stageCount = stages.length;
    const itemCount = stages.reduce((sum, stage) => sum + stage.items.length, 0);
    document.getElementById('stat-stage').textContent = String(stageCount);
    document.getElementById('stat-item').textContent = String(itemCount);
    document.getElementById('stat-avg').textContent = stageCount ? (itemCount / stageCount).toFixed(1) : '0';
  }

  function renderList(stages) {
    if (!stages.length) {
      list.innerHTML = '<div class="rounded-xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-slate-800 p-6 text-center text-gray-400">暂无阶段，点击右上角新增。</div>';
      return;
    }

    list.innerHTML = stages.map((stage) => `
      <section class="rounded-xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-slate-800 p-5">
        <div class="flex flex-wrap items-center justify-between gap-3">
          <div>
            <h2 class="text-lg font-semibold">${stage.label}</h2>
            <p class="text-sm text-gray-500">${stage.period || '未设置时间范围'}</p>
          </div>
          <div class="flex items-center gap-2 text-sm">
            <button onclick="editStage(${stage.id}, ${JSON.stringify(stage.label).replace(/"/g, '&quot;')}, ${JSON.stringify(stage.period || '').replace(/"/g, '&quot;')})" class="text-primary-500 hover:text-primary-600 cursor-pointer">编辑阶段</button>
            <button onclick="deleteStage(${stage.id})" class="text-red-500 hover:text-red-600 cursor-pointer">删除阶段</button>
            <button onclick="addItem(${stage.id})" class="px-2.5 py-1 rounded bg-primary-500 text-white hover:bg-primary-600 cursor-pointer">+ 添加成就</button>
          </div>
        </div>

        <ul class="mt-4 space-y-2">
          ${stage.items.length ? stage.items.map((item) => `
            <li class="flex items-start justify-between gap-3 rounded-lg border border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-slate-900/30 px-3 py-2">
              <span class="text-sm">· ${item.content}</span>
              <span class="text-xs text-gray-500 shrink-0">
                <button onclick="editItem(${item.id}, ${JSON.stringify(item.content).replace(/"/g, '&quot;')})" class="text-primary-500 hover:text-primary-600 mr-2 cursor-pointer">编辑</button>
                <button onclick="deleteItem(${item.id})" class="text-red-500 hover:text-red-600 cursor-pointer">删除</button>
              </span>
            </li>
          `).join('') : '<li class="text-sm text-gray-400">暂无成就条目</li>'}
        </ul>
      </section>
    `).join('');
  }

  async function postJson(url, method, payload) {
    const res = await fetch(url, {
      method,
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload),
    });
    return res.json();
  }

  window.addItem = async function(stageId) {
    const content = prompt('输入成就内容：');
    if (!content) return;
    const json = await postJson('/api/admin/highlights/items', 'POST', { stage_id: stageId, content });
    if (!json.ok) {
      alert(json.error?.message || '添加失败');
      return;
    }
    loadData();
  };

  window.editItem = async function(id, oldValue) {
    const content = prompt('编辑成就内容：', oldValue);
    if (!content) return;
    const json = await postJson('/api/admin/highlights/items/' + id, 'PUT', { content });
    if (!json.ok) {
      alert(json.error?.message || '更新失败');
      return;
    }
    loadData();
  };

  window.deleteItem = async function(id) {
    if (!confirm('确定删除这个成就吗？')) return;
    await fetch('/api/admin/highlights/items/' + id, { method: 'DELETE' });
    loadData();
  };

  window.editStage = async function(id, oldLabel, oldPeriod) {
    const label = prompt('阶段名称：', oldLabel);
    if (!label) return;
    const period = prompt('时间范围（可空）：', oldPeriod || '');
    const json = await postJson('/api/admin/highlights/stages/' + id, 'PUT', { label, period: period || null });
    if (!json.ok) {
      alert(json.error?.message || '更新失败');
      return;
    }
    loadData();
  };

  window.deleteStage = async function(id) {
    if (!confirm('确定删除这个阶段？对应成就也会一起删除。')) return;
    await fetch('/api/admin/highlights/stages/' + id, { method: 'DELETE' });
    loadData();
  };

  document.getElementById('btn-add-stage').addEventListener('click', async () => {
    const label = prompt('输入阶段名称：');
    if (!label) return;
    const period = prompt('输入时间范围（可空）：') || '';
    const json = await postJson('/api/admin/highlights/stages', 'POST', { label, period: period || null });
    if (!json.ok) {
      alert(json.error?.message || '添加失败');
      return;
    }
    loadData();
  });

  loadData();
})();
</script>
