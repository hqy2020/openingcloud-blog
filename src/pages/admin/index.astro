---
export const prerender = false;

import AdminLayout from '@/components/admin/AdminLayout.astro';

const stats = {
  posts: 0,
  provinces: 0,
  friends: 0,
  timeline: 0,
  highlights: 0,
};

try {
  const db = Astro.locals.runtime.env.BLOG_DB;
  const [postCount, provinceCount, friendCount, timelineCount, highlightCount] = await Promise.all([
    db.prepare('SELECT COUNT(*) as total FROM posts').first<{ total: number }>(),
    db.prepare('SELECT COUNT(DISTINCT province) as total FROM travel_places').first<{ total: number }>(),
    db.prepare('SELECT COUNT(*) as total FROM social_friends').first<{ total: number }>(),
    db.prepare('SELECT COUNT(*) as total FROM timeline_nodes').first<{ total: number }>(),
    db.prepare('SELECT COUNT(*) as total FROM highlight_stages').first<{ total: number }>(),
  ]);

  stats.posts = postCount?.total ?? 0;
  stats.provinces = provinceCount?.total ?? 0;
  stats.friends = friendCount?.total ?? 0;
  stats.timeline = timelineCount?.total ?? 0;
  stats.highlights = highlightCount?.total ?? 0;
} catch {
  // Keep fallback zeros when tables are not ready.
}

const dashboardCards = [
  { label: 'ç¯‡æ–‡ç« ', value: stats.posts, icon: 'ğŸ“' },
  { label: 'å·²ç‚¹äº®çœä»½', value: `${stats.provinces}/34`, icon: 'ğŸ—ºï¸' },
  { label: 'ä½å¥½å‹', value: stats.friends, icon: 'ğŸŒ' },
  { label: 'æ—¶é—´èŠ‚ç‚¹', value: stats.timeline, icon: 'ğŸ›¤ï¸' },
  { label: 'é«˜å…‰é˜¶æ®µ', value: stats.highlights, icon: 'â­' },
];

const recentLogs = [
  'å®Œæˆé¦–é¡µä¸ƒæ®µå¼é‡æ„å¹¶æ¥å…¥ç´ æå ä½',
  'æ–°å¢æ—…è¡Œ/ç¤¾äº¤/é«˜å…‰ä¸‰å¥— API ä¸ç®¡ç†é¡µéª¨æ¶',
  'åˆ†ç±»é¡µå·²åˆ‡æ¢ä¸ºåŒåˆ—ç€‘å¸ƒæµ + æ ‡ç­¾ç­›é€‰',
  'å¯ç»§ç»­åœ¨æœ¬é¡µå³ä¸Šå¯¼èˆªè¿›å…¥å„æ¨¡å—è¡¥å……çœŸå®æ•°æ®',
];
---

<AdminLayout title="ä»ªè¡¨ç›˜">
  <div class="space-y-6">
    <div class="flex items-center justify-between gap-4">
      <div>
        <h1 class="text-2xl font-bold">ğŸ“Š ä»ªè¡¨ç›˜</h1>
        <p class="text-sm text-gray-500 mt-1">é¦–é¡µæ¨¡å—ä¸å†…å®¹æ•°æ®æ¦‚è§ˆ</p>
      </div>
      <a href="/" class="text-sm text-primary-500 hover:underline">æŸ¥çœ‹å‰å°é¦–é¡µ</a>
    </div>

    <div class="grid grid-cols-2 lg:grid-cols-5 gap-3 md:gap-4">
      {dashboardCards.map((card) => (
        <div class="rounded-xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-slate-800 p-4">
          <div class="text-xl">{card.icon}</div>
          <div class="text-2xl font-bold mt-2">{card.value}</div>
          <div class="text-xs text-gray-500 mt-1">{card.label}</div>
        </div>
      ))}
    </div>

    <div class="rounded-xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-slate-800 p-5">
      <h2 class="text-lg font-semibold mb-3">æœ€è¿‘åŠ¨æ€</h2>
      <ul class="space-y-2 text-sm text-gray-600 dark:text-gray-300">
        {recentLogs.map((log) => (
          <li>Â· {log}</li>
        ))}
      </ul>
    </div>
  </div>
</AdminLayout>
