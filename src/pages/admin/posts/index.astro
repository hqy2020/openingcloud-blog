---
export const prerender = false;
import AdminLayout from '@/components/admin/AdminLayout.astro';
---

<AdminLayout title="文章管理">
  <!-- 筛选栏 -->
  <div class="flex flex-col sm:flex-row gap-3 mb-6">
    <select id="filter-category" class="px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-sm">
      <option value="">全部分类</option>
      <option value="tech">技术</option>
      <option value="learning">学习</option>
      <option value="journal">日记</option>
      <option value="life">生活</option>
    </select>
    <select id="filter-draft" class="px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-sm">
      <option value="">全部状态</option>
      <option value="0">已发布</option>
      <option value="1">草稿</option>
    </select>
    <a href="/admin/posts/new" class="ml-auto px-4 py-2 bg-primary-500 hover:bg-primary-600 text-white rounded-lg text-sm font-medium transition-colors">
      新建文章
    </a>
  </div>

  <!-- 文章表格 -->
  <div class="bg-card-light dark:bg-card-dark rounded-xl shadow overflow-x-auto">
    <table class="w-full text-sm">
      <thead class="bg-gray-50 dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700">
        <tr>
          <th class="text-left px-4 py-3 font-medium">标题</th>
          <th class="text-left px-4 py-3 font-medium hidden sm:table-cell">分类</th>
          <th class="text-left px-4 py-3 font-medium hidden md:table-cell">状态</th>
          <th class="text-left px-4 py-3 font-medium hidden md:table-cell">更新时间</th>
          <th class="text-right px-4 py-3 font-medium">操作</th>
        </tr>
      </thead>
      <tbody id="posts-table-body">
        <tr><td colspan="5" class="px-4 py-8 text-center text-gray-400">加载中...</td></tr>
      </tbody>
    </table>
  </div>

  <!-- 分页 -->
  <div id="pagination" class="flex justify-center items-center gap-4 mt-6"></div>
</AdminLayout>

<script is:inline>
  const categoryLabels = { tech: '技术', learning: '学习', journal: '日记', life: '生活' };
  let currentPage = 1;

  async function loadPosts() {
    const category = document.getElementById('filter-category').value;
    const draft = document.getElementById('filter-draft').value;
    const params = new URLSearchParams({ page: String(currentPage) });
    if (category) params.set('category', category);
    if (draft !== '') params.set('draft', draft);

    const res = await fetch('/api/admin/posts?' + params);
    const { data } = await res.json();
    renderTable(data.posts);
    renderPagination(data.total, data.page, data.pageSize);
  }

  function renderTable(posts) {
    const tbody = document.getElementById('posts-table-body');
    if (!posts.length) {
      tbody.innerHTML = '<tr><td colspan="5" class="px-4 py-8 text-center text-gray-400">暂无文章</td></tr>';
      return;
    }
    tbody.innerHTML = posts.map(function(p) {
      var statusClass = p.draft ? 'bg-yellow-100 text-yellow-700 dark:bg-yellow-900 dark:text-yellow-300' : 'bg-green-100 text-green-700 dark:bg-green-900 dark:text-green-300';
      var statusText = p.draft ? '草稿' : '已发布';
      return '<tr class="border-b border-gray-100 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800/50">' +
        '<td class="px-4 py-3"><a href="/admin/posts/' + p.id + '/edit" class="text-primary-500 hover:underline">' + escapeHtml(p.title) + '</a></td>' +
        '<td class="px-4 py-3 hidden sm:table-cell">' + (categoryLabels[p.category] || p.category) + '</td>' +
        '<td class="px-4 py-3 hidden md:table-cell"><span class="px-2 py-0.5 rounded-full text-xs ' + statusClass + '">' + statusText + '</span></td>' +
        '<td class="px-4 py-3 hidden md:table-cell text-gray-500">' + (p.updated_at || '').slice(0, 16) + '</td>' +
        '<td class="px-4 py-3 text-right space-x-2">' +
          '<button onclick="toggleStatus(' + p.id + ',' + p.draft + ')" class="text-xs text-blue-500 hover:underline cursor-pointer">' + (p.draft ? '发布' : '撤回') + '</button>' +
          '<button onclick="deletePost(' + p.id + ')" class="text-xs text-red-500 hover:underline cursor-pointer">删除</button>' +
        '</td>' +
      '</tr>';
    }).join('');
  }

  function renderPagination(total, page, pageSize) {
    var totalPages = Math.ceil(total / pageSize);
    var el = document.getElementById('pagination');
    if (totalPages <= 1) { el.innerHTML = ''; return; }
    el.innerHTML =
      '<button onclick="goPage(' + (page - 1) + ')" ' + (page <= 1 ? 'disabled' : '') + ' class="px-3 py-1 rounded border text-sm disabled:opacity-50 cursor-pointer">上一页</button>' +
      '<span class="text-sm text-gray-500">' + page + ' / ' + totalPages + '</span>' +
      '<button onclick="goPage(' + (page + 1) + ')" ' + (page >= totalPages ? 'disabled' : '') + ' class="px-3 py-1 rounded border text-sm disabled:opacity-50 cursor-pointer">下一页</button>';
  }

  function escapeHtml(s) {
    var d = document.createElement('div');
    d.textContent = s;
    return d.innerHTML;
  }

  window.goPage = function(p) { currentPage = p; loadPosts(); };

  window.toggleStatus = async function(id, currentDraft) {
    await fetch('/api/admin/posts/' + id + '/status', {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ draft: currentDraft ? 0 : 1 }),
    });
    loadPosts();
  };

  window.deletePost = async function(id) {
    if (!confirm('确定删除这篇文章吗？')) return;
    await fetch('/api/admin/posts/' + id, { method: 'DELETE' });
    loadPosts();
  };

  document.getElementById('filter-category').addEventListener('change', function() { currentPage = 1; loadPosts(); });
  document.getElementById('filter-draft').addEventListener('change', function() { currentPage = 1; loadPosts(); });

  loadPosts();
</script>
