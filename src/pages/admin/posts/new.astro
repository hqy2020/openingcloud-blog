---
export const prerender = false;
import AdminLayout from '@/components/admin/AdminLayout.astro';
import PostMetaForm from '@/components/admin/PostMetaForm.astro';
import MarkdownEditor from '@/components/admin/MarkdownEditor.astro';
---

<AdminLayout title="新建文章">
  <h1 class="text-xl font-bold mb-4">新建文章</h1>

  <form id="post-form">
    <PostMetaForm />
    <MarkdownEditor />

    <div class="flex gap-3 mt-4">
      <button type="submit" data-draft="1" class="px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-lg text-sm cursor-pointer">保存草稿</button>
      <button type="submit" data-draft="0" class="px-4 py-2 bg-primary-500 hover:bg-primary-600 text-white rounded-lg text-sm cursor-pointer">保存并发布</button>
    </div>
  </form>

  <div id="form-message" class="mt-3 text-sm hidden"></div>
</AdminLayout>

<script is:inline>
(function() {
  var form = document.getElementById('post-form');
  var msgEl = document.getElementById('form-message');
  var submitDraft = 1;

  form.querySelectorAll('button[type="submit"]').forEach(function(btn) {
    btn.addEventListener('click', function() {
      submitDraft = Number(this.getAttribute('data-draft'));
    });
  });

  form.addEventListener('submit', async function(e) {
    e.preventDefault();
    msgEl.classList.add('hidden');

    var tagsRaw = document.getElementById('post-tags').value;
    var tags = tagsRaw ? tagsRaw.split(',').map(function(t) { return t.trim(); }).filter(Boolean) : [];

    var body = {
      title: document.getElementById('post-title').value,
      slug: document.getElementById('post-slug').value,
      description: document.getElementById('post-description').value || undefined,
      content: window.getEditorContent(),
      category: document.getElementById('post-category').value,
      tags: tags,
      cover: document.getElementById('post-cover').value || undefined,
      draft: submitDraft,
    };

    if (!body.title || !body.slug || !body.content) {
      showMessage('标题、slug 和内容为必填项', true);
      return;
    }

    try {
      var res = await fetch('/api/admin/posts', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body),
      });
      var data = await res.json();
      if (data.ok) {
        window.clearEditorDraft();
        window.location.href = '/admin/posts/' + data.data.id + '/edit';
      } else {
        showMessage(data.error?.message || '创建失败', true);
      }
    } catch {
      showMessage('网络错误', true);
    }
  });

  function showMessage(text, isError) {
    msgEl.textContent = text;
    msgEl.className = 'mt-3 text-sm ' + (isError ? 'text-red-500' : 'text-green-500');
  }

  // 自动生成 slug
  document.getElementById('post-title').addEventListener('input', function() {
    var slugEl = document.getElementById('post-slug');
    if (!slugEl.dataset.manual) {
      slugEl.value = this.value
        .toLowerCase()
        .replace(/[^a-z0-9\u4e00-\u9fff]+/g, '-')
        .replace(/^-|-$/g, '');
    }
  });
  document.getElementById('post-slug').addEventListener('input', function() {
    this.dataset.manual = '1';
  });
})();
</script>
