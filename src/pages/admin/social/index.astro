---
export const prerender = false;
import AdminLayout from '@/components/admin/AdminLayout.astro';
---

<AdminLayout title="ç¤¾äº¤å›¾è°±ç®¡ç†">
  <div class="space-y-6">
    <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
      <h1 class="text-2xl font-bold">ğŸŒ ç¤¾äº¤å›¾è°±ç®¡ç†</h1>
      <div class="flex items-center gap-2">
        <select id="stage-filter" class="border border-gray-300 dark:border-gray-600 rounded px-2 py-1.5 text-sm bg-white dark:bg-slate-800">
          <option value="">å…¨éƒ¨é˜¶æ®µ</option>
          <option value="primary">å°å­¦</option>
          <option value="middle">åˆä¸­</option>
          <option value="high">é«˜ä¸­</option>
          <option value="tongji">åŒæµ</option>
          <option value="zju">æµ™å¤§</option>
          <option value="work">å·¥ä½œ</option>
        </select>
        <button id="btn-add" class="px-4 py-2 bg-primary-500 text-white rounded-lg text-sm hover:bg-primary-600 transition-colors cursor-pointer">+ æ–°å¢</button>
      </div>
    </div>

    <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
      <div class="rounded-xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-slate-800 p-3 text-center">
        <div class="text-xs text-gray-500">å¥½å‹æ€»æ•°</div>
        <div id="stat-total" class="text-xl font-bold mt-1">-</div>
      </div>
      <div class="rounded-xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-slate-800 p-3 text-center">
        <div class="text-xs text-gray-500">é˜¶æ®µè¦†ç›–</div>
        <div id="stat-stage" class="text-xl font-bold mt-1">-</div>
      </div>
      <div class="rounded-xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-slate-800 p-3 text-center">
        <div class="text-xs text-gray-500">æœ‰ä¸»é¡µé“¾æ¥</div>
        <div id="stat-link" class="text-xl font-bold mt-1">-</div>
      </div>
      <div class="rounded-xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-slate-800 p-3 text-center">
        <div class="text-xs text-gray-500">æœ‰å¤´åƒ</div>
        <div id="stat-avatar" class="text-xl font-bold mt-1">-</div>
      </div>
    </div>

    <div class="rounded-xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-slate-800 overflow-hidden">
      <table class="w-full text-sm">
        <thead class="bg-gray-50 dark:bg-slate-900/50">
          <tr>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">é˜¶æ®µ</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">å§“å</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">å…¬å¼€ç§°å‘¼</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ä¸€å¥è¯</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">é“¾æ¥</th>
            <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">æ“ä½œ</th>
          </tr>
        </thead>
        <tbody id="social-table" class="divide-y divide-gray-200 dark:divide-gray-700">
          <tr><td colspan="6" class="px-4 py-8 text-center text-gray-400">åŠ è½½ä¸­...</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <div id="social-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/50">
    <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-xl w-full max-w-lg mx-4 p-6">
      <h3 id="modal-title" class="text-lg font-bold mb-4">æ–°å¢å¥½å‹</h3>
      <form id="social-form" class="space-y-4">
        <input type="hidden" id="form-id" />
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium mb-1">é˜¶æ®µ *</label>
            <select id="form-stage" class="w-full border border-gray-300 dark:border-gray-600 rounded-lg px-3 py-2 bg-white dark:bg-slate-900">
              <option value="primary">å°å­¦</option>
              <option value="middle">åˆä¸­</option>
              <option value="high">é«˜ä¸­</option>
              <option value="tongji">åŒæµ</option>
              <option value="zju">æµ™å¤§</option>
              <option value="work">å·¥ä½œ</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">å¹³å°</label>
            <select id="form-platform" class="w-full border border-gray-300 dark:border-gray-600 rounded-lg px-3 py-2 bg-white dark:bg-slate-900">
              <option value="other">other</option>
              <option value="blog">blog</option>
              <option value="github">github</option>
              <option value="twitter">twitter</option>
              <option value="weibo">weibo</option>
            </select>
          </div>
        </div>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium mb-1">å§“å *</label>
            <input type="text" id="form-name" class="w-full border border-gray-300 dark:border-gray-600 rounded-lg px-3 py-2 bg-white dark:bg-slate-900" required />
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">å…¬å¼€ç§°å‘¼ *</label>
            <input type="text" id="form-public" class="w-full border border-gray-300 dark:border-gray-600 rounded-lg px-3 py-2 bg-white dark:bg-slate-900" placeholder="ä¸€ä½åŒçª—" required />
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">ä¸€å¥è¯</label>
          <input type="text" id="form-bio" class="w-full border border-gray-300 dark:border-gray-600 rounded-lg px-3 py-2 bg-white dark:bg-slate-900" />
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">å¤´åƒ URL</label>
          <input type="url" id="form-avatar" class="w-full border border-gray-300 dark:border-gray-600 rounded-lg px-3 py-2 bg-white dark:bg-slate-900" />
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">ä¸»é¡µé“¾æ¥</label>
          <input type="url" id="form-link" class="w-full border border-gray-300 dark:border-gray-600 rounded-lg px-3 py-2 bg-white dark:bg-slate-900" />
        </div>

        <div class="flex justify-end gap-3 pt-2">
          <button type="button" id="btn-cancel" class="px-4 py-2 text-sm text-gray-600 hover:text-gray-800 cursor-pointer">å–æ¶ˆ</button>
          <button type="submit" class="px-4 py-2 bg-primary-500 text-white rounded-lg text-sm hover:bg-primary-600 cursor-pointer">ä¿å­˜</button>
        </div>
      </form>
    </div>
  </div>
</AdminLayout>

<script is:inline>
(function() {
  const table = document.getElementById('social-table');
  const filter = document.getElementById('stage-filter');
  const modal = document.getElementById('social-modal');
  const form = document.getElementById('social-form');

  const stageLabelMap = {
    primary: 'å°å­¦',
    middle: 'åˆä¸­',
    high: 'é«˜ä¸­',
    tongji: 'åŒæµ',
    zju: 'æµ™å¤§',
    work: 'å·¥ä½œ',
  };

  async function loadFriends() {
    const params = new URLSearchParams();
    if (filter.value) params.set('stage_id', filter.value);
    const res = await fetch('/api/admin/social?' + params.toString());
    const json = await res.json();
    if (!json.ok) return;

    const rows = json.data.friends;
    renderTable(rows);
    renderStats(rows);
  }

  function renderTable(rows) {
    if (!rows.length) {
      table.innerHTML = '<tr><td colspan="6" class="px-4 py-8 text-center text-gray-400">æš‚æ— æ•°æ®</td></tr>';
      return;
    }

    table.innerHTML = rows.map((row) => `
      <tr class="hover:bg-gray-50 dark:hover:bg-slate-700/40">
        <td class="px-4 py-3">${stageLabelMap[row.stage_id] || row.stage_id}</td>
        <td class="px-4 py-3 font-medium">${row.name}</td>
        <td class="px-4 py-3">${row.public_label}</td>
        <td class="px-4 py-3 text-gray-500 max-w-[250px] truncate">${row.bio || ''}</td>
        <td class="px-4 py-3">${row.link ? '<a class="text-primary-500 hover:underline" href="' + row.link + '" target="_blank" rel="noopener">é“¾æ¥</a>' : 'â€”'}</td>
        <td class="px-4 py-3 text-right">
          <button onclick="editFriend(${row.id})" class="text-primary-500 hover:text-primary-600 text-sm mr-2 cursor-pointer">ç¼–è¾‘</button>
          <button onclick="deleteFriend(${row.id})" class="text-red-500 hover:text-red-600 text-sm cursor-pointer">åˆ é™¤</button>
        </td>
      </tr>
    `).join('');
  }

  function renderStats(rows) {
    const stageCount = new Set(rows.map((r) => r.stage_id)).size;
    const linkCount = rows.filter((r) => !!r.link).length;
    const avatarCount = rows.filter((r) => !!r.avatar).length;

    document.getElementById('stat-total').textContent = String(rows.length);
    document.getElementById('stat-stage').textContent = String(stageCount);
    document.getElementById('stat-link').textContent = String(linkCount);
    document.getElementById('stat-avatar').textContent = String(avatarCount);
  }

  function openModal(item) {
    document.getElementById('modal-title').textContent = item ? 'ç¼–è¾‘å¥½å‹' : 'æ–°å¢å¥½å‹';
    document.getElementById('form-id').value = item?.id || '';
    document.getElementById('form-stage').value = item?.stage_id || 'tongji';
    document.getElementById('form-platform').value = item?.platform || 'other';
    document.getElementById('form-name').value = item?.name || '';
    document.getElementById('form-public').value = item?.public_label || '';
    document.getElementById('form-bio').value = item?.bio || '';
    document.getElementById('form-avatar').value = item?.avatar || '';
    document.getElementById('form-link').value = item?.link || '';
    modal.classList.remove('hidden');
  }

  window.editFriend = async function(id) {
    const res = await fetch('/api/admin/social/' + id);
    const json = await res.json();
    if (json.ok) openModal(json.data);
  };

  window.deleteFriend = async function(id) {
    if (!confirm('ç¡®å®šåˆ é™¤è¿™ä½å¥½å‹å—ï¼Ÿ')) return;
    await fetch('/api/admin/social/' + id, { method: 'DELETE' });
    loadFriends();
  };

  document.getElementById('btn-add').addEventListener('click', () => openModal(null));
  document.getElementById('btn-cancel').addEventListener('click', () => modal.classList.add('hidden'));
  filter.addEventListener('change', loadFriends);

  modal.addEventListener('click', (event) => {
    if (event.target === modal) modal.classList.add('hidden');
  });

  form.addEventListener('submit', async (event) => {
    event.preventDefault();
    const id = document.getElementById('form-id').value;
    const payload = {
      stage_id: document.getElementById('form-stage').value,
      platform: document.getElementById('form-platform').value,
      name: document.getElementById('form-name').value.trim(),
      public_label: document.getElementById('form-public').value.trim(),
      bio: document.getElementById('form-bio').value.trim() || null,
      avatar: document.getElementById('form-avatar').value.trim() || null,
      link: document.getElementById('form-link').value.trim() || null,
    };

    const url = id ? '/api/admin/social/' + id : '/api/admin/social';
    const method = id ? 'PUT' : 'POST';

    const res = await fetch(url, {
      method,
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload),
    });
    const json = await res.json();

    if (json.ok) {
      modal.classList.add('hidden');
      loadFriends();
    } else {
      alert(json.error?.message || 'ä¿å­˜å¤±è´¥');
    }
  });

  loadFriends();
})();
</script>
