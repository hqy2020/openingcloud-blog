---
export const prerender = false;
import AdminLayout from '@/components/admin/AdminLayout.astro';
---

<AdminLayout title="æ—…è¡Œè¶³è¿¹ç®¡ç†">
  <div class="space-y-6">
    <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
      <h1 class="text-2xl font-bold">ğŸ—ºï¸ æ—…è¡Œè¶³è¿¹ç®¡ç†</h1>
      <div class="flex items-center gap-2">
        <select id="province-filter" class="border border-gray-300 dark:border-gray-600 rounded px-2 py-1.5 text-sm bg-white dark:bg-slate-800">
          <option value="">å…¨éƒ¨çœä»½</option>
        </select>
        <button id="btn-add" class="px-4 py-2 bg-primary-500 text-white rounded-lg text-sm hover:bg-primary-600 transition-colors cursor-pointer">+ æ–°å¢</button>
      </div>
    </div>

    <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
      <div class="rounded-xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-slate-800 p-3 text-center">
        <div class="text-xs text-gray-500">å·²ç‚¹äº®</div>
        <div id="stat-province" class="text-xl font-bold mt-1">-</div>
      </div>
      <div class="rounded-xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-slate-800 p-3 text-center">
        <div class="text-xs text-gray-500">åŸå¸‚è®°å½•</div>
        <div id="stat-city" class="text-xl font-bold mt-1">-</div>
      </div>
      <div class="rounded-xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-slate-800 p-3 text-center">
        <div class="text-xs text-gray-500">å½“å‰æ‰€åœ¨</div>
        <div id="stat-current" class="text-xl font-bold mt-1">-</div>
      </div>
      <div class="rounded-xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-slate-800 p-3 text-center">
        <div class="text-xs text-gray-500">è¦†ç›–ç‡</div>
        <div id="stat-ratio" class="text-xl font-bold mt-1">-</div>
      </div>
    </div>

    <div class="rounded-xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-slate-800 overflow-hidden">
      <table class="w-full text-sm">
        <thead class="bg-gray-50 dark:bg-slate-900/50">
          <tr>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">çœä»½</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">åŸå¸‚</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">æ—¶é—´æ®µ</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">æ ‡ç­¾</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">å½“å‰</th>
            <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">æ“ä½œ</th>
          </tr>
        </thead>
        <tbody id="travel-table" class="divide-y divide-gray-200 dark:divide-gray-700">
          <tr><td colspan="6" class="px-4 py-8 text-center text-gray-400">åŠ è½½ä¸­...</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <div id="travel-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/50">
    <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-xl w-full max-w-lg mx-4 p-6">
      <h3 id="modal-title" class="text-lg font-bold mb-4">æ–°å¢åŸå¸‚è®°å½•</h3>
      <form id="travel-form" class="space-y-4">
        <input type="hidden" id="form-id" />
        <div>
          <label class="block text-sm font-medium mb-1">çœä»½ *</label>
          <input type="text" id="form-province" class="w-full border border-gray-300 dark:border-gray-600 rounded-lg px-3 py-2 bg-white dark:bg-slate-900" required />
        </div>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium mb-1">åŸå¸‚ *</label>
            <input type="text" id="form-city" class="w-full border border-gray-300 dark:border-gray-600 rounded-lg px-3 py-2 bg-white dark:bg-slate-900" required />
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">æ ‡ç­¾ *</label>
            <select id="form-tag" class="w-full border border-gray-300 dark:border-gray-600 rounded-lg px-3 py-2 bg-white dark:bg-slate-900" required>
              <option value="æ±‚å­¦">æ±‚å­¦</option>
              <option value="å·¥ä½œ">å·¥ä½œ</option>
              <option value="æ—…è¡Œ">æ—…è¡Œ</option>
              <option value="ç”Ÿæ´»">ç”Ÿæ´»</option>
            </select>
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">æ—¶é—´æ®µ *</label>
          <input type="text" id="form-period" placeholder="2024-09 â†’ è‡³ä»Š" class="w-full border border-gray-300 dark:border-gray-600 rounded-lg px-3 py-2 bg-white dark:bg-slate-900" required />
        </div>
        <label class="inline-flex items-center gap-2 text-sm"><input type="checkbox" id="form-current" class="cursor-pointer" /> å½“å‰æ‰€åœ¨</label>

        <div class="flex justify-end gap-3 pt-2">
          <button type="button" id="btn-cancel" class="px-4 py-2 text-sm text-gray-600 hover:text-gray-800 cursor-pointer">å–æ¶ˆ</button>
          <button type="submit" class="px-4 py-2 bg-primary-500 text-white rounded-lg text-sm hover:bg-primary-600 cursor-pointer">ä¿å­˜</button>
        </div>
      </form>
    </div>
  </div>
</AdminLayout>

<script is:inline>
(function() {
  const table = document.getElementById('travel-table');
  const filter = document.getElementById('province-filter');
  const modal = document.getElementById('travel-modal');
  const form = document.getElementById('travel-form');
  let cache = [];

  async function loadPlaces() {
    const params = new URLSearchParams();
    if (filter.value) params.set('province', filter.value);

    const res = await fetch('/api/admin/travel?' + params.toString());
    const json = await res.json();
    if (!json.ok) return;

    cache = json.data.places;
    renderTable(cache);
    renderStats(json.data.places);
    renderProvinceFilter(json.data.places);
  }

  function renderTable(rows) {
    if (!rows.length) {
      table.innerHTML = '<tr><td colspan="6" class="px-4 py-8 text-center text-gray-400">æš‚æ— æ•°æ®</td></tr>';
      return;
    }

    table.innerHTML = rows.map((row) => `
      <tr class="hover:bg-gray-50 dark:hover:bg-slate-700/40">
        <td class="px-4 py-3 font-medium">${row.province}</td>
        <td class="px-4 py-3">${row.city}</td>
        <td class="px-4 py-3 text-gray-500">${row.period}</td>
        <td class="px-4 py-3">${row.tag}</td>
        <td class="px-4 py-3">${row.is_current ? 'â­' : 'â€”'}</td>
        <td class="px-4 py-3 text-right">
          <button onclick="editPlace(${row.id})" class="text-primary-500 hover:text-primary-600 text-sm mr-2 cursor-pointer">ç¼–è¾‘</button>
          <button onclick="deletePlace(${row.id})" class="text-red-500 hover:text-red-600 text-sm cursor-pointer">åˆ é™¤</button>
        </td>
      </tr>
    `).join('');
  }

  function renderStats(rows) {
    const provinceCount = new Set(rows.map((r) => r.province)).size;
    const currentCount = rows.filter((r) => r.is_current).length;
    document.getElementById('stat-province').textContent = `${provinceCount} / 34`;
    document.getElementById('stat-city').textContent = String(rows.length);
    document.getElementById('stat-current').textContent = String(currentCount);
    document.getElementById('stat-ratio').textContent = `${Math.round((provinceCount / 34) * 100)}%`;
  }

  function renderProvinceFilter(rows) {
    const options = [...new Set(rows.map((r) => r.province))].sort();
    const current = filter.value;
    filter.innerHTML = '<option value="">å…¨éƒ¨çœä»½</option>' + options.map((name) => `<option value="${name}">${name}</option>`).join('');
    filter.value = current;
  }

  function openModal(item) {
    document.getElementById('modal-title').textContent = item ? 'ç¼–è¾‘åŸå¸‚è®°å½•' : 'æ–°å¢åŸå¸‚è®°å½•';
    document.getElementById('form-id').value = item?.id || '';
    document.getElementById('form-province').value = item?.province || '';
    document.getElementById('form-city').value = item?.city || '';
    document.getElementById('form-period').value = item?.period || '';
    document.getElementById('form-tag').value = item?.tag || 'æ±‚å­¦';
    document.getElementById('form-current').checked = !!item?.is_current;
    modal.classList.remove('hidden');
  }

  window.editPlace = async function(id) {
    const res = await fetch('/api/admin/travel/' + id);
    const json = await res.json();
    if (json.ok) openModal(json.data);
  };

  window.deletePlace = async function(id) {
    if (!confirm('ç¡®å®šåˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ')) return;
    await fetch('/api/admin/travel/' + id, { method: 'DELETE' });
    loadPlaces();
  };

  document.getElementById('btn-add').addEventListener('click', () => openModal(null));
  document.getElementById('btn-cancel').addEventListener('click', () => modal.classList.add('hidden'));
  filter.addEventListener('change', loadPlaces);

  modal.addEventListener('click', (event) => {
    if (event.target === modal) modal.classList.add('hidden');
  });

  form.addEventListener('submit', async (event) => {
    event.preventDefault();
    const id = document.getElementById('form-id').value;
    const payload = {
      province: document.getElementById('form-province').value.trim(),
      city: document.getElementById('form-city').value.trim(),
      period: document.getElementById('form-period').value.trim(),
      tag: document.getElementById('form-tag').value,
      is_current: document.getElementById('form-current').checked ? 1 : 0,
    };

    const url = id ? '/api/admin/travel/' + id : '/api/admin/travel';
    const method = id ? 'PUT' : 'POST';

    const res = await fetch(url, {
      method,
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload),
    });
    const json = await res.json();

    if (json.ok) {
      modal.classList.add('hidden');
      loadPlaces();
    } else {
      alert(json.error?.message || 'ä¿å­˜å¤±è´¥');
    }
  });

  loadPlaces();
})();
</script>
