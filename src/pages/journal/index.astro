---
import BaseLayout from '@/layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';
import { CategoryMasonry } from '@/react/sections/CategoryMasonry';

const posts = (await getCollection('journal', ({ data }) => !data.draft))
  .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());

function countWords(raw: string) {
  const plainText = raw
    .replace(/```[\s\S]*?```/g, ' ')
    .replace(/`[^`]*`/g, ' ')
    .replace(/<[^>]*>/g, ' ')
    .replace(/[#>*_\-\[\]()]/g, ' ')
    .replace(/\s+/g, ' ')
    .trim();

  const cjk = (plainText.match(/[\u4e00-\u9fff]/g) || []).length;
  const english = plainText.replace(/[\u4e00-\u9fff]/g, ' ').split(/\s+/).filter(Boolean).length;
  return cjk + english;
}

function mockViews(seed: string) {
  let hash = 0;
  for (let i = 0; i < seed.length; i++) hash = (hash * 33 + seed.charCodeAt(i)) % 100000;
  return 80 + (hash % 2600);
}

const postsForLayout = posts.map((post) => ({
  title: post.data.title,
  description: post.data.description,
  date: post.data.date.toISOString(),
  category: post.data.category,
  tags: post.data.tags,
  cover: post.data.cover,
  slug: post.id,
  words: countWords(post.body),
  views: mockViews(post.id),
}));
---

<BaseLayout title="日记 & 计划复盘" sidebar={false}>
  <CategoryMasonry
    client:load
    posts={postsForLayout}
    title="日记"
    subtitle="记录每日思考、计划执行与阶段复盘。"
    categoryKey="journal"
  />
</BaseLayout>
