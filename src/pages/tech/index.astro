---
import BaseLayout from '@/layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';
import { CategoryMasonry } from '@/react/sections/CategoryMasonry';

const posts = (await getCollection('tech', ({ data }) => !data.draft))
  .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());

function countWords(raw: string) {
  const plainText = raw
    .replace(/```[\s\S]*?```/g, ' ')
    .replace(/`[^`]*`/g, ' ')
    .replace(/<[^>]*>/g, ' ')
    .replace(/[#>*_\-\[\]()]/g, ' ')
    .replace(/\s+/g, ' ')
    .trim();

  const cjk = (plainText.match(/[\u4e00-\u9fff]/g) || []).length;
  const english = plainText.replace(/[\u4e00-\u9fff]/g, ' ').split(/\s+/).filter(Boolean).length;
  return cjk + english;
}

const postsForLayout = posts.map((post) => ({
  title: post.data.title,
  description: post.data.description,
  date: post.data.date.toISOString(),
  category: post.data.category,
  tags: post.data.tags,
  cover: post.data.cover,
  slug: post.id,
  words: countWords(post.body),
  views: 0,
}));
---

<BaseLayout title="技术博客" sidebar={false}>
  <CategoryMasonry
    client:load
    posts={postsForLayout}
    title="技术"
    subtitle="探索代码世界的边界，沉淀可复用的工程经验。"
    categoryKey="tech"
  />
</BaseLayout>
